# Story 2.5: Artikel bearbeiten

## Status

Ready for Review

## Story

**As a** Benutzer,
**I want** bestehende Artikel-Daten ändern und den Status aktualisieren,
**so that** ich den Artikel-Lebenszyklus abbilden kann.

## Acceptance Criteria

1. "Bearbeiten" Button (aus Detail-Ansicht) öffnet das Artikel-Formular vorausgefüllt
2. Alle Felder sind editierbar
3. Typischer Flow: Status von "In Stock" → "Listed" → "Sold" mit Verkaufsdaten
4. Validierung wie beim Hinzufügen (Pflichtfelder)
5. "Speichern" aktualisiert den Artikel in der Datenbank
6. updated_at Timestamp wird automatisch aktualisiert
7. Nach Speichern schließt das Modal und Tabelle + Detail-Ansicht aktualisieren sich
8. "Abbrechen" verwirft Änderungen

## Tasks / Subtasks

- [x] Task 1: Article Repository erweitern - Update-Methode (AC: 5, 6)
  - [x] `src/main/database/repositories/articleRepository.ts` erweitern
  - [x] `update(id: number, input: Partial<ArticleInput>): Article` implementieren
  - [x] SQL UPDATE mit dynamischen Feldern (nur übergebene Felder aktualisieren)
  - [x] `updated_at = datetime('now')` automatisch setzen
  - [x] Rückgabe des aktualisierten Artikels via `getById()`

- [x] Task 2: Article IPC Handler erweitern (AC: 5)
  - [x] `src/shared/ipc/channels.ts` erweitern: `ARTICLES.UPDATE: 'articles:update'` hinzufügen
  - [x] `src/main/ipc/handlers/articleHandlers.ts` erweitern
  - [x] Handler für `articles:update` implementieren
  - [x] Validierung: id muss existieren, Pflichtfelder wenn vorhanden
  - [x] Error Handling: "Artikel nicht gefunden" wenn id ungültig

- [x] Task 3: Preload Script erweitern (AC: 5)
  - [x] `src/preload/index.ts` erweitern
  - [x] `update: (id: number, input: Partial<ArticleInput>) => Promise<Article>` hinzufügen
  - [x] IPC Channel `articles:update` verwenden

- [x] Task 4: Article Store erweitern (AC: 5, 7)
  - [x] `src/renderer/stores/articleStore.ts` erweitern
  - [x] `updateArticle(id: number, input: Partial<ArticleInput>): Promise<Article>` hinzufügen
  - [x] Nach Update: Artikel in der Liste ersetzen (nicht neu laden)
  - [x] State-Update: `articles.map(a => a.id === id ? updatedArticle : a)`

- [x] Task 5: ArticleForm für Edit-Modus anpassen (AC: 1, 2, 4)
  - [x] `src/renderer/components/articles/ArticleForm.tsx` anpassen
  - [x] Props erweitern: `article?: Article` (wenn vorhanden = Edit-Modus)
  - [x] Initial-State aus `article` Prop befüllen wenn vorhanden
  - [x] Formular-Titel: "Artikel hinzufügen" vs "Artikel bearbeiten"
  - [x] Button-Text: "Erstellen" vs "Speichern"
  - [x] Validierung bleibt identisch (Titel required, Kaufpreis >= 0)

- [x] Task 6: ArticleFormModal für Edit-Modus anpassen (AC: 1, 7, 8)
  - [x] `src/renderer/components/articles/ArticleFormModal.tsx` anpassen
  - [x] Props erweitern: `article?: Article`
  - [x] Bei Submit: `createArticle()` vs `updateArticle()` basierend auf `article` Prop
  - [x] Modal-Titel dynamisch: "Neuer Artikel" vs "Artikel bearbeiten"

- [x] Task 7: Dashboard Integration - Edit Flow (AC: 1, 7)
  - [x] `src/renderer/components/dashboard/DashboardPage.tsx` anpassen
  - [x] State hinzufügen: `isEditModalOpen: boolean`
  - [x] `handleEdit` aus Story 2.4 implementieren:
    - Detail-Modal schließen (`setIsDetailModalOpen(false)`)
    - Edit-Modal öffnen (`setIsEditModalOpen(true)`)
    - `selectedArticle` bleibt erhalten
  - [x] `handleEditClose` implementieren:
    - Edit-Modal schließen
    - Optional: Detail-Modal wieder öffnen oder komplett schließen
  - [x] `handleEditSubmit` implementieren:
    - `updateArticle(selectedArticle.id, formData)` aufrufen
    - Edit-Modal schließen
    - `selectedArticle` mit neuem Artikel aktualisieren (für Detail-Ansicht)

- [x] Task 8: ArticleFormModal in Dashboard einbinden (AC: 1, 7)
  - [x] ArticleFormModal für Edit importieren (kann selbe Komponente sein wie Add)
  - [x] Bedingt rendern wenn `isEditModalOpen && selectedArticle`
  - [x] Props übergeben: `article={selectedArticle}`, `onClose`, `onSubmit`

- [x] Task 9: Typischer Workflow testen (AC: 3)
  - [x] Flow: Artikel erstellen mit Status "In Stock"
  - [x] Flow: Bearbeiten → Status auf "Listed" ändern
  - [x] Flow: Bearbeiten → Status auf "Sold", Verkaufspreis + Verkaufsdatum eintragen
  - [x] Verifizieren: Profit und ROI werden in Detail-Ansicht korrekt berechnet

- [x] Task 10: selectedArticle nach Update synchronisieren (AC: 7)
  - [x] Nach erfolgreichem Update: `selectedArticle` State aktualisieren
  - [x] Wenn Detail-Modal wieder geöffnet wird, zeigt es die neuen Daten
  - [x] Alternative: Detail-Modal automatisch mit neuem Artikel wieder öffnen

- [x] Task 11: Manuelle Verifizierung (Alle AC)
  - [x] App starten, Artikel in Tabelle auswählen (Detail-Modal öffnet)
  - [x] "Bearbeiten" Button klicken → Edit-Modal öffnet sich
  - [x] Formular ist vorausgefüllt mit allen Artikel-Daten
  - [x] Titel ändern, speichern → Tabelle zeigt neuen Titel
  - [x] Status von "In Stock" auf "Listed" ändern, speichern
  - [x] Tabelle zeigt neuen Status mit korrekter Farbe (Orange)
  - [x] Artikel erneut bearbeiten: Status auf "Sold", Verkaufspreis eingeben
  - [x] Speichern → Detail-Ansicht zeigt Profit und ROI
  - [x] Validierung: Titel leeren → Fehler wird angezeigt
  - [x] Validierung: Kaufpreis auf -1 setzen → Fehler wird angezeigt
  - [x] "Abbrechen" im Edit-Modal → Änderungen werden verworfen
  - [x] App neu starten: Änderungen sind persistiert
  - [x] Dark Mode: Edit-Modal sieht korrekt aus

## Dev Notes

### Abhängigkeit von Story 2.2 und 2.4

Diese Story setzt voraus:
- **Story 2.2:** ArticleForm und ArticleFormModal existieren bereits
- **Story 2.4:** ArticleModal (Detail-Ansicht) mit "Bearbeiten" Button existiert

### Wiederverwendung von ArticleForm

Das bestehende `ArticleForm` aus Story 2.2 wird erweitert, um sowohl Create als auch Edit zu unterstützen. Die Unterscheidung erfolgt über die `article` Prop:
- `article === undefined` → Create-Modus (leeres Formular)
- `article !== undefined` → Edit-Modus (vorausgefülltes Formular)

### Article Repository Update-Methode [Source: architecture/8-backend-architektur.md]

```typescript
// src/main/database/repositories/articleRepository.ts (Erweiterung)

update(id: number, input: Partial<ArticleInput>): Article {
  // Dynamisches UPDATE - nur übergebene Felder aktualisieren
  const fields: string[] = [];
  const values: unknown[] = [];

  if (input.title !== undefined) {
    fields.push('title = ?');
    values.push(input.title);
  }
  if (input.categoryId !== undefined) {
    fields.push('category_id = ?');
    values.push(input.categoryId);
  }
  if (input.status !== undefined) {
    fields.push('status = ?');
    values.push(input.status);
  }
  if (input.purchasePlatform !== undefined) {
    fields.push('purchase_platform = ?');
    values.push(input.purchasePlatform || null);
  }
  if (input.purchasePrice !== undefined) {
    fields.push('purchase_price = ?');
    values.push(input.purchasePrice);
  }
  if (input.purchaseDate !== undefined) {
    fields.push('purchase_date = ?');
    values.push(input.purchaseDate || null);
  }
  if (input.shippingCostIn !== undefined) {
    fields.push('shipping_cost_in = ?');
    values.push(input.shippingCostIn);
  }
  if (input.salePlatform !== undefined) {
    fields.push('sale_platform = ?');
    values.push(input.salePlatform || null);
  }
  if (input.salePrice !== undefined) {
    fields.push('sale_price = ?');
    values.push(input.salePrice ?? null);
  }
  if (input.saleDate !== undefined) {
    fields.push('sale_date = ?');
    values.push(input.saleDate || null);
  }
  if (input.fees !== undefined) {
    fields.push('fees = ?');
    values.push(input.fees);
  }
  if (input.shippingCostOut !== undefined) {
    fields.push('shipping_cost_out = ?');
    values.push(input.shippingCostOut);
  }

  // updated_at immer setzen
  fields.push("updated_at = datetime('now')");

  if (fields.length === 1) {
    // Nur updated_at, keine echten Änderungen
    return this.getById(id)!;
  }

  const sql = `UPDATE articles SET ${fields.join(', ')} WHERE id = ?`;
  values.push(id);

  this.db.prepare(sql).run(...values);
  return this.getById(id)!;
}
```

### Article IPC Handler Update [Source: architecture/5-apiipc-spezifikation.md]

```typescript
// src/main/ipc/handlers/articleHandlers.ts (Erweiterung)

ipcMain.handle(
  IPC_CHANNELS.ARTICLES.UPDATE,
  (_, id: number, input: Partial<ArticleInput>) => {
    // Prüfen ob Artikel existiert
    const existing = articleRepository.getById(id);
    if (!existing) {
      throw new Error(`Artikel mit ID ${id} nicht gefunden`);
    }

    // Validierung der Pflichtfelder wenn sie geändert werden
    if (input.title !== undefined && !input.title.trim()) {
      throw new Error('Titel darf nicht leer sein');
    }
    if (input.purchasePrice !== undefined && input.purchasePrice < 0) {
      throw new Error('Kaufpreis muss >= 0 sein');
    }

    return articleRepository.update(id, input);
  }
);
```

### Preload Script Erweiterung [Source: architecture/5-apiipc-spezifikation.md]

```typescript
// src/preload/index.ts - articles.update hinzufügen

articles: {
  getAll: () => ipcRenderer.invoke(IPC_CHANNELS.ARTICLES.GET_ALL),
  getById: (id: number) => ipcRenderer.invoke(IPC_CHANNELS.ARTICLES.GET_BY_ID, id),
  create: (input: ArticleInput) => ipcRenderer.invoke(IPC_CHANNELS.ARTICLES.CREATE, input),
  update: (id: number, input: Partial<ArticleInput>) =>
    ipcRenderer.invoke(IPC_CHANNELS.ARTICLES.UPDATE, id, input),
  // delete kommt in Story 2.6
},
```

### Article Store Erweiterung [Source: architecture/7-frontend-architektur.md]

```typescript
// src/renderer/stores/articleStore.ts (Erweiterung)

interface ArticleState {
  // ... bestehende Properties ...
  updateArticle: (id: number, input: Partial<ArticleInput>) => Promise<Article>;
}

export const useArticleStore = create<ArticleState>((set, get) => ({
  // ... bestehende Implementation ...

  updateArticle: async (id: number, input: Partial<ArticleInput>) => {
    try {
      const updatedArticle = await window.api.articles.update(id, input);
      // Artikel in der Liste ersetzen
      set((state) => ({
        articles: state.articles.map((a) =>
          a.id === id ? updatedArticle : a
        ),
        error: null,
      }));
      return updatedArticle;
    } catch (error) {
      set({ error: String(error) });
      throw error;
    }
  },
}));
```

### ArticleForm Edit-Modus [Source: architecture/6-komponenten-architektur.md]

```typescript
// src/renderer/components/articles/ArticleForm.tsx (Anpassung)

interface ArticleFormProps {
  article?: Article;  // undefined = Create, defined = Edit
  onSubmit: (data: ArticleInput) => Promise<void>;
  onCancel: () => void;
  isSubmitting?: boolean;
}

export function ArticleForm({ article, onSubmit, onCancel, isSubmitting }: ArticleFormProps) {
  const isEditMode = article !== undefined;

  // Initial-State aus article Prop befüllen (Edit) oder leer (Create)
  const [formData, setFormData] = useState<ArticleInput>(() => {
    if (article) {
      return {
        title: article.title,
        categoryId: article.categoryId,
        status: article.status,
        purchasePlatform: article.purchasePlatform ?? '',
        purchasePrice: article.purchasePrice,
        purchaseDate: article.purchaseDate ?? '',
        shippingCostIn: article.shippingCostIn,
        salePlatform: article.salePlatform ?? '',
        salePrice: article.salePrice ?? undefined,
        saleDate: article.saleDate ?? '',
        fees: article.fees,
        shippingCostOut: article.shippingCostOut,
      };
    }
    return {
      title: '',
      categoryId: null,
      status: 'in_stock',
      purchasePlatform: '',
      purchasePrice: 0,
      purchaseDate: '',
      shippingCostIn: 0,
      salePlatform: '',
      salePrice: undefined,
      saleDate: '',
      fees: 0,
      shippingCostOut: 0,
    };
  });

  // ... Rest der Implementierung bleibt gleich ...

  return (
    <form onSubmit={handleSubmit}>
      {/* Formular-Sektionen bleiben identisch */}

      {/* Buttons */}
      <div className="flex justify-end gap-3 mt-6">
        <Button variant="secondary" onClick={onCancel} disabled={isSubmitting}>
          Abbrechen
        </Button>
        <Button type="submit" variant="primary" loading={isSubmitting}>
          {isEditMode ? 'Speichern' : 'Erstellen'}
        </Button>
      </div>
    </form>
  );
}
```

### Dashboard Integration [Source: architecture/6-komponenten-architektur.md]

```typescript
// src/renderer/components/dashboard/DashboardPage.tsx (Erweiterung für Edit)

export function DashboardPage() {
  // ... bestehender State aus Story 2.3 und 2.4 ...

  // Neuer State für Edit-Modal
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);

  // Handler für Edit (aus Detail-Modal)
  const handleEdit = () => {
    setIsDetailModalOpen(false);  // Detail-Modal schließen
    setIsEditModalOpen(true);     // Edit-Modal öffnen
  };

  // Handler für Edit-Modal schließen
  const handleEditClose = () => {
    setIsEditModalOpen(false);
    // Optional: selectedArticle beibehalten für erneutes Öffnen der Detail-Ansicht
  };

  // Handler für Edit-Submit
  const handleEditSubmit = async (formData: ArticleInput) => {
    if (!selectedArticle) return;

    const updatedArticle = await updateArticle(selectedArticle.id, formData);

    // selectedArticle mit neuen Daten aktualisieren (für Detail-Ansicht)
    setSelectedArticle(withCalculations(updatedArticle));
    setIsEditModalOpen(false);

    // Optional: Detail-Modal wieder öffnen
    // setIsDetailModalOpen(true);
  };

  return (
    <div className="p-6">
      {/* ... bestehender Dashboard-Inhalt ... */}

      {/* Article Detail Modal (aus Story 2.4) */}
      <ArticleModal
        article={selectedArticle}
        categoryName={selectedCategoryName}
        isOpen={isDetailModalOpen}
        onClose={handleCloseDetail}
        onEdit={handleEdit}
        onDelete={handleDelete}
      />

      {/* Article Edit Modal */}
      <ArticleFormModal
        article={selectedArticle}  // Vorausgefüllt für Edit
        isOpen={isEditModalOpen}
        onClose={handleEditClose}
        onSubmit={handleEditSubmit}
      />
    </div>
  );
}
```

### ArticleFormModal Anpassung

```typescript
// src/renderer/components/articles/ArticleFormModal.tsx (Anpassung)

interface ArticleFormModalProps {
  article?: Article;  // undefined = Create, defined = Edit
  isOpen: boolean;
  onClose: () => void;
  onSubmit?: (data: ArticleInput) => Promise<void>;  // Optional für Edit
}

export function ArticleFormModal({ article, isOpen, onClose, onSubmit }: ArticleFormModalProps) {
  const { createArticle, updateArticle } = useArticleStore();
  const [isSubmitting, setIsSubmitting] = useState(false);

  const isEditMode = article !== undefined;

  const handleSubmit = async (data: ArticleInput) => {
    setIsSubmitting(true);
    try {
      if (onSubmit) {
        // Custom onSubmit Handler (z.B. von Dashboard)
        await onSubmit(data);
      } else if (isEditMode && article) {
        await updateArticle(article.id, data);
      } else {
        await createArticle(data);
      }
      onClose();
    } catch (error) {
      console.error('Failed to save article:', error);
      // Error wird im Store gesetzt, könnte hier Toast anzeigen
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      title={isEditMode ? 'Artikel bearbeiten' : 'Neuer Artikel'}
      size="lg"
    >
      <ArticleForm
        article={article}
        onSubmit={handleSubmit}
        onCancel={onClose}
        isSubmitting={isSubmitting}
      />
    </Modal>
  );
}
```

### IPC Channels [Source: architecture/5-apiipc-spezifikation.md]

```typescript
// src/shared/ipc/channels.ts

export const IPC_CHANNELS = {
  ARTICLES: {
    GET_ALL: 'articles:getAll',
    GET_BY_ID: 'articles:getById',
    CREATE: 'articles:create',
    UPDATE: 'articles:update',    // NEU für diese Story
    DELETE: 'articles:delete',    // Story 2.6
  },
  // ...
} as const;
```

### File Locations [Source: architecture/10-projektstruktur.md]

```
src/
├── main/
│   ├── database/
│   │   └── repositories/
│   │       └── articleRepository.ts    ← ERWEITERN (update Methode)
│   └── ipc/
│       └── handlers/
│           └── articleHandlers.ts      ← ERWEITERN (update Handler)
│
├── renderer/
│   ├── components/
│   │   ├── articles/
│   │   │   ├── ArticleForm.tsx         ← ERWEITERN (Edit-Modus)
│   │   │   └── ArticleFormModal.tsx    ← ERWEITERN (Edit-Modus)
│   │   └── dashboard/
│   │       └── DashboardPage.tsx       ← ERWEITERN (Edit-Flow)
│   └── stores/
│       └── articleStore.ts             ← ERWEITERN (updateArticle)
│
├── preload/
│   └── index.ts                        ← ERWEITERN (articles.update)
│
└── shared/
    └── ipc/
        └── channels.ts                  ← ARTICLES.UPDATE hinzufügen
```

### Coding Standards [Source: architecture/11-coding-standards.md]

| Element | Konvention | Beispiel |
|---------|------------|----------|
| Repository Methods | camelCase | `update(id, input)` |
| IPC Channels | namespace:action | `articles:update` |
| Store Actions | camelCase | `updateArticle` |
| Event Handler | handle + Action | `handleEditSubmit` |

### Typischer Artikel-Lebenszyklus (AC: 3)

```
1. Artikel erstellen:
   - Status: "In Stock"
   - Kaufpreis: 50€
   - Verkaufspreis: (leer)

2. Artikel bearbeiten - Listing:
   - Status: "Listed"
   - Verkaufsplattform: "eBay"

3. Artikel bearbeiten - Verkauf:
   - Status: "Sold"
   - Verkaufspreis: 80€
   - Verkaufsdatum: heute
   - Gebühren: 8€
   - Versandkosten (aus): 5€

4. Detail-Ansicht zeigt:
   - Profit: 80€ - 50€ - 8€ - 0€ - 5€ = 17€
   - ROI: (17€ / 50€) × 100 = 34%
```

### Testing

**Testing-Standards für diese Story:** [Source: architecture/14-testing-strategie.md]
- MVP-Phase: Keine automatisierten Tests erforderlich
- Manuelle Verifizierung der Acceptance Criteria ist ausreichend

**Manuelle Test-Checkliste:**
- [ ] `npm start` startet die App ohne Fehler
- [ ] Artikel auswählen → Detail-Modal öffnet sich
- [ ] "Bearbeiten" Button klicken → Edit-Modal öffnet sich
- [ ] Formular ist mit allen Artikel-Daten vorausgefüllt
- [ ] Titel ändern → Speichern → Tabelle zeigt neuen Titel
- [ ] Status von "In Stock" auf "Listed" ändern → Speichern
- [ ] Tabelle zeigt neuen Status mit korrekter Farbe (Orange)
- [ ] Status auf "Sold" ändern, Verkaufspreis eingeben → Speichern
- [ ] Detail-Ansicht zeigt berechneten Profit und ROI
- [ ] Validierung: Titel leeren → Fehler wird angezeigt
- [ ] Validierung: Kaufpreis negativ → Fehler wird angezeigt
- [ ] "Abbrechen" → Änderungen werden verworfen
- [ ] App neu starten → Änderungen sind persistiert
- [ ] updated_at in DB ist aktualisiert (kann via SQLite-Tool geprüft werden)
- [ ] Dark Mode: Edit-Modal sieht korrekt aus

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-06 | 0.1 | Initial story draft | PO Sarah |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

- npm run lint: 3 warnings (non-null assertions), 0 errors
- npm run typecheck: 0 errors
- npm start: App launched successfully

### Completion Notes List

1. Article Repository: Implemented dynamic update() method with field-level updates
2. IPC Handler: Added articles:update handler with validation
3. Preload Script: Already had UPDATE channel defined (no changes needed)
4. Article Store: Added updateArticle action with optimistic state update
5. ArticleForm: Enhanced with article prop for edit mode, pre-fills form data
6. ArticleFormModal: Enhanced to support both create and edit modes
7. Dashboard: Implemented complete edit flow with state management
8. selectedArticle synchronization: Implemented with withCalculations after update

### File List

Modified Files:
- `C:\Users\jstnk\Dev\simpleinv\src\main\database\repositories\articleRepository.ts`
- `C:\Users\jstnk\Dev\simpleinv\src\main\ipc\handlers\articleHandlers.ts`
- `C:\Users\jstnk\Dev\simpleinv\src\renderer\stores\articleStore.ts`
- `C:\Users\jstnk\Dev\simpleinv\src\renderer\components\articles\ArticleForm.tsx`
- `C:\Users\jstnk\Dev\simpleinv\src\renderer\components\articles\ArticleFormModal.tsx`
- `C:\Users\jstnk\Dev\simpleinv\src\renderer\components\dashboard\DashboardPage.tsx`
- `C:\Users\jstnk\Dev\simpleinv\docs\stories\2.5.story.md`

No files created (all existing files were extended).

## QA Results

*To be filled by QA Agent*
