# Story 3.2: Profit- und ROI-Berechnung finalisieren

## Status

Approved

## Story

**As a** Benutzer,
**I want** dass Profit und ROI korrekt und konsistent berechnet werden,
**so that** ich meine echte Marge kenne.

## Acceptance Criteria

1. Profit-Berechnung ist einheitlich in der gesamten App:
   - `Profit = Verkaufspreis − Kaufpreis − Gebühren − Versandkosten_ein − Versandkosten_aus`
2. ROI-Berechnung ist einheitlich:
   - `ROI = (Profit ÷ Kaufpreis) × 100`
   - Gerundet auf 2 Dezimalstellen
   - Anzeige mit %-Zeichen (z.B. "45,23%")
3. Berechnungen werden NICHT in der Datenbank gespeichert (immer live berechnet)
4. Bei fehlenden Werten (null/undefined):
   - Fehlende Gebühren/Versandkosten werden als 0 behandelt
   - Fehlender Verkaufspreis: Profit und ROI werden als "–" angezeigt
5. Negative Profits werden korrekt berechnet und rot dargestellt
6. Berechnungslogik ist in einer wiederverwendbaren Utility-Funktion gekapselt
7. Tabelle und Detail-Ansicht verwenden dieselbe Berechnungslogik

## Tasks / Subtasks

- [ ] Task 1: Calculation Utilities konsolidieren (AC: 1, 2, 3, 6)
  - [ ] `src/shared/utils/calculations.ts` erstellen/überprüfen
  - [ ] `calculateProfit(article: Article): number | null` implementieren
  - [ ] `calculateRoi(article: Article): number | null` implementieren
  - [ ] TypeScript-Typen für Article mit optionalen Feldern nutzen
  - [ ] Null-Handling: salePrice null → return null

- [ ] Task 2: ArticleWithCalculations Type definieren (AC: 3, 6)
  - [ ] `src/shared/types/article.ts` erweitern
  - [ ] Interface `ArticleWithCalculations` erstellen
  - [ ] Enthält: `...Article`, `profit: number | null`, `roi: number | null`
  - [ ] Utility-Funktion `withCalculations(article: Article): ArticleWithCalculations`

- [ ] Task 3: Formatierungs-Utilities für Profit/ROI (AC: 2, 4, 5)
  - [ ] `src/renderer/utils/formatters.ts` erweitern
  - [ ] `formatProfit(profit: number | null): string` → "€ 35,00" oder "–"
  - [ ] `formatRoi(roi: number | null): string` → "45,23%" oder "–"
  - [ ] Profit-Farb-Logik: `getProfitColorClass(profit: number | null): string`

- [ ] Task 4: ArticleTable Profit-Spalte überprüfen (AC: 1, 4, 5, 7)
  - [ ] Profit-Berechnung verwendet `calculateProfit()` Utility
  - [ ] Profit-Formatierung verwendet `formatProfit()` Utility
  - [ ] Farbcodierung: Grün für positiv, Rot für negativ, Grau für "–"
  - [ ] Sortierung funktioniert mit null-Werten

- [ ] Task 5: ArticleModal Berechnungen überprüfen (AC: 1, 2, 4, 5, 7)
  - [ ] Detail-Ansicht zeigt Profit mit `calculateProfit()` und `formatProfit()`
  - [ ] Detail-Ansicht zeigt ROI mit `calculateRoi()` und `formatRoi()`
  - [ ] Beide Werte verwenden konsistente Farbcodierung
  - [ ] Bei nicht verkauften Artikeln: "Noch nicht verkauft" oder "–"

- [ ] Task 6: Dashboard-Metriken Konsistenz prüfen (AC: 1, 3)
  - [ ] MetricsService verwendet dieselbe Profit-Formel wie Utilities
  - [ ] SQL-Berechnung = TypeScript-Berechnung (verifizieren)
  - [ ] Edge Case: Artikel ohne Verkaufspreis werden nicht in Gesamtprofit gezählt

- [ ] Task 7: Edge Cases implementieren und testen (AC: 4, 5)
  - [ ] Kaufpreis = 0 → ROI sollte 0% oder nicht berechnet werden (Division by zero)
  - [ ] Alle optionalen Felder null → Profit = salePrice - purchasePrice
  - [ ] Negativer Profit → Korrekte Berechnung und Darstellung
  - [ ] Sehr große Zahlen → Formatierung mit Tausender-Trennern

- [ ] Task 8: Manuelle Verifizierung (Alle AC)
  - [ ] Artikel erstellen mit: Kaufpreis €50, keine Verkaufsdaten
  - [ ] → Tabelle zeigt Profit "–", Detail zeigt "Noch nicht verkauft"
  - [ ] Artikel bearbeiten: Verkaufspreis €100, Gebühren €5, Versand ein €5, aus €10
  - [ ] → Profit = €30 (100-50-5-5-10), ROI = 60% (30/50*100)
  - [ ] → Tabelle und Detail zeigen identische Werte
  - [ ] Artikel mit Verlust: Verkaufspreis €40 bei Kaufpreis €50
  - [ ] → Profit = -€10 (rot), ROI = -20% (rot)
  - [ ] Profit-Sortierung in Tabelle: null-Werte am Ende

## Dev Notes

### Kontext aus vorherigen Stories

**Epic 2** hat Basis-Profit-Berechnung implementiert:
- ArticleTable zeigt bereits eine Profit-Spalte
- ArticleModal zeigt bereits Profit und ROI
- Diese Story **konsolidiert** und **standardisiert** die Berechnungslogik

**Story 3.1** hat Dashboard-Metriken implementiert:
- MetricsService berechnet Gesamtprofit im Backend
- Diese Story stellt sicher, dass Frontend und Backend dieselbe Formel verwenden

### Profit-Formel [Source: PRD FR7]

```
Profit = sale_price - purchase_price - fees - shipping_cost_in - shipping_cost_out
```

**Alle optionalen Felder (fees, shipping_cost_in, shipping_cost_out) werden als 0 behandelt wenn null.**

### ROI-Formel [Source: PRD FR7]

```
ROI = (Profit / purchase_price) * 100
```

**Gerundet auf 2 Dezimalstellen, angezeigt als "45,23%"**

### Calculation Utilities Implementation

```typescript
// src/shared/utils/calculations.ts

import type { Article } from '../types/article';

/**
 * Berechnet den Profit eines Artikels
 * @returns Profit in Euro oder null wenn kein Verkaufspreis vorhanden
 */
export function calculateProfit(article: Article): number | null {
  if (article.salePrice === null || article.salePrice === undefined) {
    return null;
  }

  const purchasePrice = article.purchasePrice ?? 0;
  const fees = article.fees ?? 0;
  const shippingCostIn = article.shippingCostIn ?? 0;
  const shippingCostOut = article.shippingCostOut ?? 0;

  return article.salePrice - purchasePrice - fees - shippingCostIn - shippingCostOut;
}

/**
 * Berechnet den ROI (Return on Investment) eines Artikels
 * @returns ROI in Prozent (z.B. 45.23 für 45,23%) oder null
 */
export function calculateRoi(article: Article): number | null {
  const profit = calculateProfit(article);

  if (profit === null) {
    return null;
  }

  const purchasePrice = article.purchasePrice;

  // Division by zero vermeiden
  if (!purchasePrice || purchasePrice === 0) {
    return profit === 0 ? 0 : null;
  }

  const roi = (profit / purchasePrice) * 100;
  return Math.round(roi * 100) / 100; // Auf 2 Dezimalstellen runden
}
```

### ArticleWithCalculations Type

```typescript
// src/shared/types/article.ts

import type { Article } from './article';
import { calculateProfit, calculateRoi } from '../utils/calculations';

export interface ArticleWithCalculations extends Article {
  profit: number | null;
  roi: number | null;
}

/**
 * Erweitert einen Artikel um berechnete Felder
 */
export function withCalculations(article: Article): ArticleWithCalculations {
  return {
    ...article,
    profit: calculateProfit(article),
    roi: calculateRoi(article),
  };
}
```

### Formatierungs-Utilities

```typescript
// src/renderer/utils/formatters.ts

/**
 * Formatiert Profit-Werte
 * @returns "€ 35,00", "-€ 10,00" oder "–"
 */
export function formatProfit(profit: number | null): string {
  if (profit === null) {
    return '–';
  }
  return formatCurrency(profit);
}

/**
 * Formatiert ROI-Werte
 * @returns "45,23%" oder "–"
 */
export function formatRoi(roi: number | null): string {
  if (roi === null) {
    return '–';
  }
  return `${roi.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%`;
}

/**
 * Gibt die Tailwind-Klasse für Profit-Färbung zurück
 */
export function getProfitColorClass(profit: number | null): string {
  if (profit === null) {
    return 'text-gray-400';
  }
  if (profit > 0) {
    return 'text-green-600 dark:text-green-400';
  }
  if (profit < 0) {
    return 'text-red-600 dark:text-red-400';
  }
  return 'text-gray-600 dark:text-gray-400'; // profit === 0
}
```

### Tabellen-Integration Pattern

```typescript
// In ArticleTable.tsx

const columns = [
  // ... andere Spalten
  {
    accessorKey: 'profit',
    header: 'Profit',
    cell: ({ row }) => {
      const profit = row.original.profit;
      return (
        <span className={getProfitColorClass(profit)}>
          {formatProfit(profit)}
        </span>
      );
    },
    sortingFn: (rowA, rowB) => {
      const a = rowA.original.profit ?? Number.MIN_SAFE_INTEGER;
      const b = rowB.original.profit ?? Number.MIN_SAFE_INTEGER;
      return a - b;
    },
  },
];
```

### Detail-Ansicht Pattern

```typescript
// In ArticleModal.tsx

<div className="space-y-2">
  <div className="flex justify-between">
    <span className="text-gray-500">Profit</span>
    <span className={getProfitColorClass(article.profit)}>
      {formatProfit(article.profit)}
    </span>
  </div>
  <div className="flex justify-between">
    <span className="text-gray-500">ROI</span>
    <span className={getProfitColorClass(article.profit)}>
      {formatRoi(article.roi)}
    </span>
  </div>
</div>
```

### SQL vs. TypeScript Konsistenz

**Backend (MetricsService):**
```sql
SELECT COALESCE(SUM(
  COALESCE(sale_price, 0) -
  COALESCE(purchase_price, 0) -
  COALESCE(fees, 0) -
  COALESCE(shipping_cost_in, 0) -
  COALESCE(shipping_cost_out, 0)
), 0) as totalProfit
FROM articles
WHERE status = 'sold'
```

**Frontend (calculations.ts):**
```typescript
return salePrice - purchasePrice - fees - shippingCostIn - shippingCostOut;
```

**WICHTIG:** Beide Formeln müssen identisch sein!

### File Locations [Source: architecture/10-projektstruktur.md]

```
src/
├── shared/
│   ├── types/
│   │   └── article.ts              ← ArticleWithCalculations hinzufügen
│   └── utils/
│       └── calculations.ts         ← NEU oder konsolidieren
│
└── renderer/
    └── utils/
        └── formatters.ts           ← formatProfit, formatRoi, getProfitColorClass
```

### Coding Standards [Source: architecture/11-coding-standards.md]

| Element | Konvention | Beispiel |
|---------|------------|----------|
| Utility Functions | camelCase | `calculateProfit` |
| Type Interfaces | PascalCase | `ArticleWithCalculations` |

**Kritische Regeln:**
- Berechnungen NICHT in DB speichern (immer live)
- Shared Utils in `src/shared/utils/` für Main + Renderer Zugriff
- Rendering Utils in `src/renderer/utils/` (Formatierung, Farben)

### Edge Cases Matrix

| Szenario | salePrice | purchasePrice | fees | shipping | Erwartetes Ergebnis |
|----------|-----------|---------------|------|----------|---------------------|
| Nicht verkauft | null | 50 | - | - | Profit: null ("–") |
| Einfacher Verkauf | 100 | 50 | 0 | 0 | Profit: 50, ROI: 100% |
| Mit Gebühren | 100 | 50 | 10 | 5+5 | Profit: 30, ROI: 60% |
| Verlust | 40 | 50 | 5 | 0 | Profit: -15, ROI: -30% |
| Kaufpreis 0 | 50 | 0 | 0 | 0 | Profit: 50, ROI: null |
| Alles null außer Pflicht | 100 | 50 | null | null | Profit: 50, ROI: 100% |

### Testing

**Testing-Standards für diese Story:** [Source: architecture/14-testing-strategie.md]
- MVP-Phase: Keine automatisierten Tests erforderlich
- Manuelle Verifizierung der Acceptance Criteria ist ausreichend
- **Empfehlung:** Unit Tests für `calculateProfit` und `calculateRoi` sind einfach und wertvoll

**Manuelle Test-Checkliste:**
- [ ] `npm start` startet die App ohne Fehler
- [ ] Artikel ohne Verkaufsdaten: Profit "–" in Tabelle und Detail
- [ ] Artikel mit vollständigen Daten: Profit und ROI korrekt berechnet
- [ ] Formel verifizieren: 100 - 50 - 5 - 5 - 10 = 30, ROI = 60%
- [ ] Negativer Profit: Wert korrekt, Farbe rot
- [ ] Positiver Profit: Wert korrekt, Farbe grün
- [ ] Tabelle und Detail zeigen identische Werte
- [ ] Dashboard Gesamtprofit = Summe aller Einzelprofits (bei "sold")
- [ ] Sortierung nach Profit: null-Werte am Ende

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-06 | 0.1 | Initial story draft | PO Sarah |

## Dev Agent Record

### Agent Model Used

*To be filled by Dev Agent*

### Debug Log References

*To be filled by Dev Agent*

### Completion Notes List

*To be filled by Dev Agent*

### File List

*To be filled by Dev Agent*

## QA Results

*To be filled by QA Agent*
