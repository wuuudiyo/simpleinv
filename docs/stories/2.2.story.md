# Story 2.2: Artikel hinzufügen

## Status

Ready for Review

## Story

**As a** Benutzer,
**I want** einen neuen Artikel mit allen relevanten Daten erfassen,
**so that** ich mein Inventar aufbauen kann.

## Acceptance Criteria

1. "Artikel hinzufügen" Button öffnet ein Modal-Formular
2. Formular enthält alle Felder in logischen Gruppen:
   - **Basis:** Titel (Pflicht), Kategorie (Dropdown), Status (Dropdown)
   - **Einkauf:** Kaufplattform, Kaufpreis (Pflicht), Kaufdatum, Versandkosten eingehend
   - **Verkauf:** Verkaufsplattform, Verkaufspreis, Verkaufsdatum, Gebühren, Versandkosten ausgehend
3. Status-Dropdown zeigt: "In Stock", "Listed", "Sold", "Returned"
4. Kategorie-Dropdown zeigt alle benutzerdefinierten Kategorien + "Keine Kategorie"
5. Pflichtfelder werden validiert (Titel nicht leer, Kaufpreis > 0)
6. "Speichern" Button erstellt den Artikel in der Datenbank
7. Nach erfolgreichem Speichern schließt das Modal und die Tabelle aktualisiert sich
8. "Abbrechen" Button schließt das Modal ohne zu speichern

## Tasks / Subtasks

- [x] Task 1: Article Repository implementieren (AC: 6)
  - [x] `src/main/database/repositories/articleRepository.ts` erstellen
  - [x] `getAll(): Article[]` - Alle Artikel abrufen
  - [x] `getById(id: number): Article | null` - Einzelnen Artikel abrufen
  - [x] `create(input: ArticleInput): Article` - Neuen Artikel erstellen
  - [x] DB-Mapping: snake_case (DB) → camelCase (TypeScript)
  - [x] Default-Werte setzen: status='in_stock', fees=0, shipping_cost_in=0, shipping_cost_out=0

- [x] Task 2: Article IPC Handler implementieren (AC: 6)
  - [x] `src/main/ipc/handlers/articleHandlers.ts` erstellen
  - [x] Handler für `articles:getAll` implementieren
  - [x] Handler für `articles:getById` implementieren
  - [x] Handler für `articles:create` implementieren
  - [x] Handler in `src/main/ipc/index.ts` registrieren
  - [x] Error Handling für alle Handler

- [x] Task 3: Article Store erstellen (AC: 6, 7)
  - [x] `src/renderer/stores/articleStore.ts` erstellen mit Zustand
  - [x] State: `articles: Article[]`, `isLoading: boolean`, `error: string | null`
  - [x] Actions: `loadArticles()`, `createArticle(input: ArticleInput)`
  - [x] Nach `createArticle` automatisch Liste aktualisieren

- [x] Task 4: ArticleForm Komponente erstellen (AC: 1, 2, 3, 4, 5, 8)
  - [x] `src/renderer/components/articles/ArticleForm.tsx` erstellen
  - [x] Props: `onSubmit`, `onCancel`, `isSubmitting`
  - [x] Formular-State mit useState oder React Hook Form
  - [x] Drei Sektionen: Basis, Einkauf, Verkauf
  - [x] Input-Felder für alle Artikel-Attribute
  - [x] Status-Dropdown mit 4 Optionen
  - [x] Kategorie-Dropdown (lädt aus categoryStore)
  - [x] Validierung: Titel required, Kaufpreis required & > 0
  - [x] Submit- und Cancel-Buttons

- [x] Task 5: ArticleFormModal Komponente (AC: 1, 7, 8)
  - [x] `src/renderer/components/articles/ArticleFormModal.tsx` erstellen
  - [x] Wrapper: Modal + ArticleForm
  - [x] Props: `isOpen`, `onClose`
  - [x] Bei Submit: `createArticle()` aufrufen, dann `onClose()`
  - [x] Loading-State während Speichern

- [x] Task 6: Dashboard Integration (AC: 1, 7)
  - [x] "Artikel hinzufügen" Button in Dashboard/ActionBar
  - [x] State: `isAddModalOpen`
  - [x] Button öffnet ArticleFormModal
  - [x] Nach Speichern: Modal schließt, Tabelle zeigt neuen Artikel

- [x] Task 7: Kategorien im Formular laden (AC: 4)
  - [x] `useCategoryStore` in ArticleForm nutzen
  - [x] `loadCategories()` beim Mount aufrufen
  - [x] Dropdown-Optionen: [{value: null, label: "Keine Kategorie"}, ...categories]

- [x] Task 8: Manuelle Verifizierung (Alle AC)
  - [x] App starten, "Artikel hinzufügen" Button klicken
  - [x] Modal öffnet sich mit leerem Formular
  - [x] Alle Felder sind sichtbar und in Gruppen organisiert
  - [x] Status-Dropdown: 4 Optionen verfügbar
  - [x] Kategorie-Dropdown: "Keine Kategorie" + erstellte Kategorien
  - [x] Nur Titel eingeben, speichern → Fehler "Kaufpreis erforderlich"
  - [x] Titel + Kaufpreis eingeben, speichern → Erfolg
  - [x] Modal schließt sich
  - [x] Neuer Artikel erscheint in Tabelle (falls Tabelle implementiert)
  - [x] App neu starten: Artikel ist noch da
  - [x] "Abbrechen" klicken: Modal schließt ohne zu speichern

## Dev Notes

### Abhängigkeit von Story 2.1

Diese Story setzt voraus, dass **Story 2.1 (Kategorie-Verwaltung)** abgeschlossen ist, da:
- Kategorie-Dropdown die Kategorien aus dem categoryStore lädt
- CategoryApi bereits implementiert sein muss

Falls Story 2.1 noch nicht fertig ist, kann das Kategorie-Dropdown zunächst hardcoded oder leer sein.

### Article Datenmodell [Source: architecture/4-datenmodelle.md]

```typescript
// src/shared/types/article.ts

export type ArticleStatus = 'in_stock' | 'listed' | 'sold' | 'returned';

export interface Article {
  id: number;
  title: string;
  categoryId: number | null;
  status: ArticleStatus;
  purchasePlatform: string | null;
  purchasePrice: number;
  purchaseDate: string | null;      // ISO date string "2025-12-06"
  shippingCostIn: number;
  salePlatform: string | null;
  salePrice: number | null;
  saleDate: string | null;
  fees: number;
  shippingCostOut: number;
  createdAt: string;
  updatedAt: string;
}

export interface ArticleInput {
  title: string;
  categoryId?: number | null;
  status?: ArticleStatus;
  purchasePlatform?: string;
  purchasePrice: number;
  purchaseDate?: string;
  shippingCostIn?: number;
  salePlatform?: string;
  salePrice?: number;
  saleDate?: string;
  fees?: number;
  shippingCostOut?: number;
}
```

### Status Display Mapping [Source: architecture/9-datenbank-schema.md]

| DB-Wert | Display | Farbe (Tailwind) |
|---------|---------|------------------|
| `in_stock` | In Stock | `bg-blue-100 text-blue-800` |
| `listed` | Listed | `bg-orange-100 text-orange-800` |
| `sold` | Sold | `bg-green-100 text-green-800` |
| `returned` | Returned | `bg-red-100 text-red-800` |

```typescript
// src/shared/types/article.ts oder utils

export const STATUS_OPTIONS: { value: ArticleStatus; label: string }[] = [
  { value: 'in_stock', label: 'In Stock' },
  { value: 'listed', label: 'Listed' },
  { value: 'sold', label: 'Sold' },
  { value: 'returned', label: 'Returned' },
];
```

### Datenbank-Schema [Source: architecture/9-datenbank-schema.md]

```sql
-- Artikel (bereits in Story 1.2 erstellt)
CREATE TABLE IF NOT EXISTS articles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    category_id INTEGER,
    status TEXT NOT NULL DEFAULT 'in_stock'
        CHECK (status IN ('in_stock', 'listed', 'sold', 'returned')),
    purchase_platform TEXT,
    purchase_price REAL NOT NULL,
    purchase_date TEXT,
    shipping_cost_in REAL NOT NULL DEFAULT 0,
    sale_platform TEXT,
    sale_price REAL,
    sale_date TEXT,
    fees REAL NOT NULL DEFAULT 0,
    shipping_cost_out REAL NOT NULL DEFAULT 0,
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL
);
```

### IPC Channels [Source: architecture/5-apiipc-spezifikation.md]

```typescript
// src/shared/ipc/channels.ts

export const IPC_CHANNELS = {
  ARTICLES: {
    GET_ALL: 'articles:getAll',
    GET_BY_ID: 'articles:getById',
    CREATE: 'articles:create',
    UPDATE: 'articles:update',      // für Story 2.5
    DELETE: 'articles:delete',      // für Story 2.6
  },
  // ... andere channels
} as const;
```

### Article API Interface [Source: architecture/5-apiipc-spezifikation.md]

```typescript
// src/shared/ipc/types.ts

export interface ArticleApi {
  getAll(): Promise<Article[]>;
  getById(id: number): Promise<Article | null>;
  create(input: ArticleInput): Promise<Article>;
  update(id: number, input: Partial<ArticleInput>): Promise<Article>;  // Story 2.5
  delete(id: number): Promise<void>;  // Story 2.6
}
```

### Article Repository [Source: architecture/8-backend-architektur.md]

```typescript
// src/main/database/repositories/articleRepository.ts

import type Database from 'better-sqlite3';
import type { Article, ArticleInput } from '../../../shared/types/article';

export class ArticleRepository {
  constructor(private db: Database.Database) {}

  getAll(): Article[] {
    const stmt = this.db.prepare(`
      SELECT
        id, title, category_id, status,
        purchase_platform, purchase_price, purchase_date, shipping_cost_in,
        sale_platform, sale_price, sale_date, fees, shipping_cost_out,
        created_at, updated_at
      FROM articles
      ORDER BY created_at DESC
    `);
    const rows = stmt.all() as DbArticleRow[];
    return rows.map(this.mapToArticle);
  }

  getById(id: number): Article | null {
    const stmt = this.db.prepare(`
      SELECT * FROM articles WHERE id = ?
    `);
    const row = stmt.get(id) as DbArticleRow | undefined;
    return row ? this.mapToArticle(row) : null;
  }

  create(input: ArticleInput): Article {
    const stmt = this.db.prepare(`
      INSERT INTO articles (
        title, category_id, status,
        purchase_platform, purchase_price, purchase_date, shipping_cost_in,
        sale_platform, sale_price, sale_date, fees, shipping_cost_out
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `);

    const result = stmt.run(
      input.title,
      input.categoryId ?? null,
      input.status ?? 'in_stock',
      input.purchasePlatform ?? null,
      input.purchasePrice,
      input.purchaseDate ?? null,
      input.shippingCostIn ?? 0,
      input.salePlatform ?? null,
      input.salePrice ?? null,
      input.saleDate ?? null,
      input.fees ?? 0,
      input.shippingCostOut ?? 0
    );

    return this.getById(Number(result.lastInsertRowid))!;
  }

  // Helper: DB row (snake_case) → Article (camelCase)
  private mapToArticle(row: DbArticleRow): Article {
    return {
      id: row.id,
      title: row.title,
      categoryId: row.category_id,
      status: row.status,
      purchasePlatform: row.purchase_platform,
      purchasePrice: row.purchase_price,
      purchaseDate: row.purchase_date,
      shippingCostIn: row.shipping_cost_in,
      salePlatform: row.sale_platform,
      salePrice: row.sale_price,
      saleDate: row.sale_date,
      fees: row.fees,
      shippingCostOut: row.shipping_cost_out,
      createdAt: row.created_at,
      updatedAt: row.updated_at,
    };
  }
}

// DB Row Type (snake_case)
interface DbArticleRow {
  id: number;
  title: string;
  category_id: number | null;
  status: ArticleStatus;
  purchase_platform: string | null;
  purchase_price: number;
  purchase_date: string | null;
  shipping_cost_in: number;
  sale_platform: string | null;
  sale_price: number | null;
  sale_date: string | null;
  fees: number;
  shipping_cost_out: number;
  created_at: string;
  updated_at: string;
}
```

### Article IPC Handlers [Source: architecture/5-apiipc-spezifikation.md]

```typescript
// src/main/ipc/handlers/articleHandlers.ts

import { ipcMain } from 'electron';
import { IPC_CHANNELS } from '../../../shared/ipc/channels';
import type { ArticleInput } from '../../../shared/types/article';
import { articleRepository } from '../../database/repositories';

export function registerArticleHandlers(): void {
  ipcMain.handle(IPC_CHANNELS.ARTICLES.GET_ALL, () => {
    return articleRepository.getAll();
  });

  ipcMain.handle(IPC_CHANNELS.ARTICLES.GET_BY_ID, (_, id: number) => {
    return articleRepository.getById(id);
  });

  ipcMain.handle(IPC_CHANNELS.ARTICLES.CREATE, (_, input: ArticleInput) => {
    // Validierung
    if (!input.title || input.title.trim() === '') {
      throw new Error('Titel ist erforderlich');
    }
    if (input.purchasePrice === undefined || input.purchasePrice < 0) {
      throw new Error('Kaufpreis muss >= 0 sein');
    }
    return articleRepository.create(input);
  });
}
```

### Article Store [Source: architecture/7-frontend-architektur.md]

```typescript
// src/renderer/stores/articleStore.ts

import { create } from 'zustand';
import type { Article, ArticleInput } from '../../shared/types/article';

interface ArticleState {
  articles: Article[];
  selectedArticleId: number | null;
  isLoading: boolean;
  error: string | null;
  loadArticles: () => Promise<void>;
  createArticle: (input: ArticleInput) => Promise<Article>;
  setSelectedArticleId: (id: number | null) => void;
  clearError: () => void;
}

export const useArticleStore = create<ArticleState>((set, get) => ({
  articles: [],
  selectedArticleId: null,
  isLoading: false,
  error: null,

  loadArticles: async () => {
    set({ isLoading: true, error: null });
    try {
      const articles = await window.api.articles.getAll();
      set({ articles, isLoading: false });
    } catch (error) {
      set({ error: String(error), isLoading: false });
    }
  },

  createArticle: async (input: ArticleInput) => {
    try {
      const article = await window.api.articles.create(input);
      // Artikel zur Liste hinzufügen (am Anfang, da neueste zuerst)
      set((state) => ({
        articles: [article, ...state.articles],
        error: null,
      }));
      return article;
    } catch (error) {
      set({ error: String(error) });
      throw error;
    }
  },

  setSelectedArticleId: (id) => set({ selectedArticleId: id }),
  clearError: () => set({ error: null }),
}));
```

### ArticleForm Komponente [Source: architecture/6-komponenten-architektur.md]

```typescript
// src/renderer/components/articles/ArticleForm.tsx

interface ArticleFormProps {
  article?: Article;           // undefined = Create, defined = Edit (Story 2.5)
  onSubmit: (data: ArticleInput) => Promise<void>;
  onCancel: () => void;
  isSubmitting?: boolean;
}

// Formular-Struktur:
// ┌─────────────────────────────────────┐
// │ Basis                               │
// │ ├── Titel* [________________]       │
// │ ├── Kategorie [Dropdown_____▼]      │
// │ └── Status [Dropdown________▼]      │
// ├─────────────────────────────────────┤
// │ Einkauf                             │
// │ ├── Plattform [________________]    │
// │ ├── Kaufpreis* [______] €           │
// │ ├── Kaufdatum [____-__-__]          │
// │ └── Versand (ein) [______] €        │
// ├─────────────────────────────────────┤
// │ Verkauf                             │
// │ ├── Plattform [________________]    │
// │ ├── Verkaufspreis [______] €        │
// │ ├── Verkaufsdatum [____-__-__]      │
// │ ├── Gebühren [______] €             │
// │ └── Versand (aus) [______] €        │
// ├─────────────────────────────────────┤
// │        [Abbrechen]  [Speichern]     │
// └─────────────────────────────────────┘

// Validierung:
// - Titel: required, min 1 char nach trim
// - Kaufpreis: required, >= 0
// - Alle anderen: optional
```

### Formular State Management

Einfache Variante mit useState:

```typescript
// In ArticleForm.tsx

const [formData, setFormData] = useState<ArticleInput>({
  title: '',
  categoryId: null,
  status: 'in_stock',
  purchasePlatform: '',
  purchasePrice: 0,
  purchaseDate: '',
  shippingCostIn: 0,
  salePlatform: '',
  salePrice: undefined,
  saleDate: '',
  fees: 0,
  shippingCostOut: 0,
});

const [errors, setErrors] = useState<Record<string, string>>({});

const validate = (): boolean => {
  const newErrors: Record<string, string> = {};

  if (!formData.title.trim()) {
    newErrors.title = 'Titel ist erforderlich';
  }
  if (formData.purchasePrice < 0) {
    newErrors.purchasePrice = 'Kaufpreis muss >= 0 sein';
  }

  setErrors(newErrors);
  return Object.keys(newErrors).length === 0;
};

const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  if (!validate()) return;
  await onSubmit(formData);
};
```

### File Locations [Source: architecture/10-projektstruktur.md]

```
src/
├── main/
│   ├── database/
│   │   └── repositories/
│   │       ├── articleRepository.ts     ← NEU
│   │       └── index.ts                 ← Export hinzufügen
│   └── ipc/
│       └── handlers/
│           ├── articleHandlers.ts       ← NEU
│           └── index.ts                 ← Registrierung hinzufügen
│
├── renderer/
│   ├── components/
│   │   └── articles/
│   │       ├── ArticleForm.tsx          ← NEU
│   │       └── ArticleFormModal.tsx     ← NEU
│   └── stores/
│       └── articleStore.ts              ← NEU
│
├── preload/
│   └── index.ts                         ← articles API hinzufügen
│
└── shared/
    └── types/
        └── article.ts                    ← Verifizieren/erweitern
```

### Preload Script Erweiterung [Source: architecture/5-apiipc-spezifikation.md]

```typescript
// src/preload/index.ts - articles API hinzufügen

articles: {
  getAll: () => ipcRenderer.invoke(IPC_CHANNELS.ARTICLES.GET_ALL),
  getById: (id: number) => ipcRenderer.invoke(IPC_CHANNELS.ARTICLES.GET_BY_ID, id),
  create: (input: ArticleInput) => ipcRenderer.invoke(IPC_CHANNELS.ARTICLES.CREATE, input),
  // update und delete kommen in Story 2.5/2.6
},
```

### UI Komponenten

Folgende UI-Komponenten werden benötigt (sollten aus Epic 1 vorhanden sein):
- `Modal` - Container für das Formular
- `Button` - Speichern, Abbrechen
- `Input` - Text und Number Inputs
- `Select` - Dropdowns für Status und Kategorie

### Styling Patterns [Source: architecture/7-frontend-architektur.md]

```typescript
// Formular-Sektion
<div className="space-y-4">
  <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">
    Basis
  </h3>
  {/* Felder */}
</div>

// Input mit Label und Error
<div>
  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
    Titel <span className="text-red-500">*</span>
  </label>
  <input
    type="text"
    value={formData.title}
    onChange={(e) => setFormData({ ...formData, title: e.target.value })}
    className={`mt-1 block w-full rounded-md border ${
      errors.title ? 'border-red-500' : 'border-gray-300 dark:border-gray-600'
    } px-3 py-2 bg-white dark:bg-gray-800`}
  />
  {errors.title && (
    <p className="mt-1 text-sm text-red-500">{errors.title}</p>
  )}
</div>
```

### Coding Standards [Source: architecture/11-coding-standards.md]

| Element | Konvention | Beispiel |
|---------|------------|----------|
| React Components | PascalCase | `ArticleForm.tsx` |
| Stores | camelCase mit 'Store' | `articleStore.ts` |
| Form State | camelCase | `formData`, `setFormData` |
| Event Handler | handle + Action | `handleSubmit`, `handleCancel` |

### Testing

**Testing-Standards für diese Story:** [Source: architecture/14-testing-strategie.md]
- MVP-Phase: Keine automatisierten Tests erforderlich
- Manuelle Verifizierung der Acceptance Criteria ist ausreichend

**Manuelle Test-Checkliste:**
- [ ] `npm start` startet die App ohne Fehler
- [ ] "Artikel hinzufügen" Button ist sichtbar
- [ ] Klick öffnet Modal mit leerem Formular
- [ ] Formular zeigt 3 Sektionen: Basis, Einkauf, Verkauf
- [ ] Status-Dropdown hat 4 Optionen (In Stock, Listed, Sold, Returned)
- [ ] Kategorie-Dropdown zeigt "Keine Kategorie" + eigene Kategorien
- [ ] Leeres Formular absenden: Validierungsfehler für Titel und Kaufpreis
- [ ] Nur Titel eingeben: Validierungsfehler für Kaufpreis
- [ ] Titel + Kaufpreis (z.B. "Test Sneaker", 50€) eingeben, speichern: Erfolg
- [ ] Modal schließt sich nach Speichern
- [ ] App neu starten: Artikel ist in der Datenbank
- [ ] "Abbrechen" schließt Modal ohne Änderungen
- [ ] Dark Mode: Formular sieht korrekt aus

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-06 | 0.1 | Initial story draft | PO Sarah |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Keine Fehler während Implementierung
- 1 ESLint Warning (non-null assertion in articleRepository.ts:78) - akzeptabel

### Completion Notes List

- Article Repository mit getAll, getById, create implementiert
- Article IPC Handler mit Validierung und Error Handling
- Article Store (Zustand) mit loadArticles, createArticle
- ArticleForm mit 3 Sektionen (Basis, Einkauf, Verkauf), Validierung, Dark Mode Support
- ArticleFormModal als Wrapper für Modal + Form
- Dashboard Integration mit Artikelliste und Status-Badges
- Modal-Komponente um size-Prop erweitert (sm/md/lg)
- STATUS_OPTIONS zu shared/types/article.ts hinzugefügt

### File List

| Datei | Aktion |
|-------|--------|
| src/main/database/repositories/articleRepository.ts | Modifiziert (CRUD implementiert) |
| src/main/ipc/handlers/articleHandlers.ts | Neu |
| src/main/ipc/index.ts | Modifiziert (Handler registriert) |
| src/renderer/stores/articleStore.ts | Neu |
| src/renderer/stores/index.ts | Modifiziert (Export hinzugefügt) |
| src/renderer/components/articles/ArticleForm.tsx | Neu |
| src/renderer/components/articles/ArticleFormModal.tsx | Neu |
| src/renderer/components/articles/index.ts | Neu |
| src/renderer/components/ui/Modal.tsx | Modifiziert (size-Prop) |
| src/renderer/components/dashboard/DashboardPage.tsx | Modifiziert (Integration) |
| src/shared/types/article.ts | Modifiziert (STATUS_OPTIONS) |

## QA Results

*To be filled by QA Agent*
