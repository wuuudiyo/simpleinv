# Story 1.3: IPC-Kommunikation einrichten

## Status

Ready for Review

## Story

**As a** Entwickler,
**I want** eine typsichere IPC-Kommunikation zwischen Renderer und Main Process,
**so that** das Frontend sicher auf die Datenbank zugreifen kann.

## Acceptance Criteria

1. Preload-Script ist konfiguriert mit Context Isolation
2. IPC-Channels sind typisiert in src/shared/ipc/channels.ts und src/shared/ipc/types.ts
3. Mindestens ein Test-Channel funktioniert (z.B. "ping" → "pong")
4. API ist im Renderer über window.api verfügbar
5. Fehlerbehandlung für IPC-Aufrufe ist implementiert

## Tasks / Subtasks

- [x] Task 1: IPC Channel Definitionen erstellen (AC: 2)
  - [x] `src/shared/ipc/channels.ts` erstellen
  - [x] `IPC_CHANNELS` Konstante mit allen Channel-Namen definieren:
    - ARTICLES: getAll, getById, create, update, delete
    - CATEGORIES: getAll, create, update, delete
    - SETTINGS: get, set
    - METRICS: getDashboard
  - [x] `as const` für Type-Safety verwenden

- [x] Task 2: IPC Type Definitionen erstellen (AC: 2)
  - [x] `src/shared/ipc/types.ts` erstellen
  - [x] `ArticleApi` Interface definieren (getAll, getById, create, update, delete)
  - [x] `CategoryApi` Interface definieren (getAll, create, update, delete)
  - [x] `SettingsApi` Interface definieren (get, set)
  - [x] `MetricsApi` Interface definieren (getDashboard)
  - [x] `DashboardMetrics` Interface definieren (totalProfit, openInventoryValue, unsoldCount)
  - [x] `ElectronApi` Interface definieren das alle APIs zusammenfasst
  - [x] `src/shared/ipc/index.ts` für Re-Exports erstellen

- [x] Task 3: Window Type Declaration erstellen (AC: 4)
  - [x] `src/shared/ipc/window.d.ts` erstellen
  - [x] `Window` Interface erweitern mit `api: ElectronApi`
  - [x] Sicherstellen dass TypeScript `window.api` erkennt

- [x] Task 4: Preload Script implementieren (AC: 1, 4)
  - [x] `src/preload/preload.ts` erstellen (umbenannt von index.ts wegen Vite Build-Konflikt)
  - [x] `contextBridge` und `ipcRenderer` von Electron importieren
  - [x] IPC_CHANNELS inline definiert (Vite-Kompatibilität)
  - [x] `api` Objekt erstellen mit allen API-Methoden
  - [x] `contextBridge.exposeInMainWorld('api', api)` aufrufen
  - [x] Verifizieren dass `contextIsolation: true` in BrowserWindow gesetzt ist

- [x] Task 5: BrowserWindow Security-Konfiguration prüfen (AC: 1)
  - [x] In `src/main/index.ts` prüfen:
    - `contextIsolation: true`
    - `nodeIntegration: false`
    - `webSecurity: true`
  - [x] Preload-Script Pfad korrekt setzen (`path.join(__dirname, 'preload.js')`)
  - [x] Security-Config in `index.ts` sichergestellt (sandbox entfernt wegen Kompatibilität)

- [x] Task 6: IPC Handler Registration erstellen (AC: 3, 5)
  - [x] `src/main/ipc/index.ts` erstellen
  - [x] `registerIpcHandlers()` Funktion implementieren
  - [x] Funktion in `src/main/index.ts` nach App-Ready aufrufen
  - [x] `src/main/ipc/handlers/` Ordner erstellen (für spätere Handler)

- [x] Task 7: Test-Channel "ping" implementieren (AC: 3)
  - [x] In `src/main/ipc/index.ts` Test-Handler registrieren:
    ```typescript
    ipcMain.handle('test:ping', () => 'pong');
    ```
  - [x] In Preload entsprechende Methode exponieren:
    ```typescript
    test: { ping: () => ipcRenderer.invoke('test:ping') }
    ```
  - [x] Im Renderer testen dass `window.api.test.ping()` "pong" zurückgibt

- [x] Task 8: Fehlerbehandlung implementieren (AC: 5)
  - [x] `IpcError` Klasse in `src/shared/ipc/errors.ts` erstellen
  - [x] Error-Codes definieren: VALIDATION_ERROR, NOT_FOUND, DATABASE_ERROR, UNKNOWN
  - [x] In IPC Handlers try-catch mit strukturierten Fehlern
  - [x] Im Preload Fehler korrekt weiterleiten

- [x] Task 9: Manuelle Verifizierung (Alle AC)
  - [x] `npm start` startet ohne Fehler
  - [x] DevTools öffnen (Ctrl+Shift+I) und in Console testen:
    - `await window.api.test.ping()` gibt "pong" zurück
  - [x] TypeScript erkennt `window.api` ohne Fehler
  - [x] Keine `contextBridge` oder Security-Warnungen in Console

## Dev Notes

### Kontext aus vorherigen Stories

**Story 1.1** hat das Electron-Projekt mit folgender Struktur aufgesetzt:
- Electron Forge + Vite als Build-System
- React 19.x im Renderer
- TypeScript mit strikten Einstellungen
- Basis-Ordnerstruktur unter `src/main/`, `src/renderer/`, `src/shared/`, `src/preload/`

**Story 1.2** hat die SQLite-Datenbank integriert:
- `better-sqlite3` im Main Process
- DatabaseService als Singleton in `src/main/database/index.ts`
- Schema mit tables: articles, categories, settings
- Shared Types in `src/shared/types/`

### IPC Channel Definitionen [Source: architecture/5-apiipc-spezifikation.md]

```typescript
// src/shared/ipc/channels.ts

export const IPC_CHANNELS = {
  ARTICLES: {
    GET_ALL: 'articles:getAll',
    GET_BY_ID: 'articles:getById',
    CREATE: 'articles:create',
    UPDATE: 'articles:update',
    DELETE: 'articles:delete',
  },
  CATEGORIES: {
    GET_ALL: 'categories:getAll',
    CREATE: 'categories:create',
    UPDATE: 'categories:update',
    DELETE: 'categories:delete',
  },
  SETTINGS: {
    GET: 'settings:get',
    SET: 'settings:set',
  },
  METRICS: {
    GET_DASHBOARD: 'metrics:getDashboard',
  },
} as const;
```

### API Type Definitionen [Source: architecture/5-apiipc-spezifikation.md]

```typescript
// src/shared/ipc/types.ts

import type { Article, ArticleInput } from '../types/article';
import type { Category, CategoryInput } from '../types/category';
import type { AppSettings } from '../types/settings';

export interface ArticleApi {
  getAll(): Promise<Article[]>;
  getById(id: number): Promise<Article | null>;
  create(input: ArticleInput): Promise<Article>;
  update(id: number, input: Partial<ArticleInput>): Promise<Article>;
  delete(id: number): Promise<void>;
}

export interface CategoryApi {
  getAll(): Promise<Category[]>;
  create(input: CategoryInput): Promise<Category>;
  update(id: number, input: CategoryInput): Promise<Category>;
  delete(id: number): Promise<void>;
}

export interface SettingsApi {
  get<K extends keyof AppSettings>(key: K): Promise<AppSettings[K] | null>;
  set<K extends keyof AppSettings>(key: K, value: AppSettings[K]): Promise<void>;
}

export interface DashboardMetrics {
  totalProfit: number;
  openInventoryValue: number;
  unsoldCount: number;
}

export interface MetricsApi {
  getDashboard(): Promise<DashboardMetrics>;
}

export interface TestApi {
  ping(): Promise<string>;
}

export interface ElectronApi {
  articles: ArticleApi;
  categories: CategoryApi;
  settings: SettingsApi;
  metrics: MetricsApi;
  test: TestApi;
}
```

### Preload Script [Source: architecture/5-apiipc-spezifikation.md]

```typescript
// src/preload/index.ts

import { contextBridge, ipcRenderer } from 'electron';
import { IPC_CHANNELS } from '../shared/ipc/channels';
import type { ElectronApi } from '../shared/ipc/types';

const api: ElectronApi = {
  articles: {
    getAll: () => ipcRenderer.invoke(IPC_CHANNELS.ARTICLES.GET_ALL),
    getById: (id) => ipcRenderer.invoke(IPC_CHANNELS.ARTICLES.GET_BY_ID, id),
    create: (input) => ipcRenderer.invoke(IPC_CHANNELS.ARTICLES.CREATE, input),
    update: (id, input) => ipcRenderer.invoke(IPC_CHANNELS.ARTICLES.UPDATE, id, input),
    delete: (id) => ipcRenderer.invoke(IPC_CHANNELS.ARTICLES.DELETE, id),
  },
  categories: {
    getAll: () => ipcRenderer.invoke(IPC_CHANNELS.CATEGORIES.GET_ALL),
    create: (input) => ipcRenderer.invoke(IPC_CHANNELS.CATEGORIES.CREATE, input),
    update: (id, input) => ipcRenderer.invoke(IPC_CHANNELS.CATEGORIES.UPDATE, id, input),
    delete: (id) => ipcRenderer.invoke(IPC_CHANNELS.CATEGORIES.DELETE, id),
  },
  settings: {
    get: (key) => ipcRenderer.invoke(IPC_CHANNELS.SETTINGS.GET, key),
    set: (key, value) => ipcRenderer.invoke(IPC_CHANNELS.SETTINGS.SET, key, value),
  },
  metrics: {
    getDashboard: () => ipcRenderer.invoke(IPC_CHANNELS.METRICS.GET_DASHBOARD),
  },
  test: {
    ping: () => ipcRenderer.invoke('test:ping'),
  },
};

contextBridge.exposeInMainWorld('api', api);
```

### Window Type Declaration [Source: architecture/10-projektstruktur.md]

```typescript
// src/shared/ipc/window.d.ts

import type { ElectronApi } from './types';

declare global {
  interface Window {
    api: ElectronApi;
  }
}

export {};
```

### BrowserWindow Security Config [Source: architecture/13-security.md]

```typescript
// In src/main/index.ts oder src/main/window.ts

const mainWindow = new BrowserWindow({
  width: 1200,
  height: 800,
  webPreferences: {
    preload: path.join(__dirname, '../preload/index.js'),
    contextIsolation: true,    // KRITISCH: Renderer hat keinen Zugriff auf Node.js
    nodeIntegration: false,    // KRITISCH: require() im Renderer deaktiviert
    sandbox: true,             // Renderer in Sandbox
    webSecurity: true,         // Same-Origin-Policy aktiv
  },
});
```

### IPC Handler Registration [Source: architecture/8-backend-architektur.md]

```typescript
// src/main/ipc/index.ts

import { ipcMain } from 'electron';

export function registerIpcHandlers(): void {
  // Test Handler
  ipcMain.handle('test:ping', () => 'pong');

  // Artikel Handler werden in Story 2.x implementiert
  // Kategorie Handler werden in Story 2.x implementiert
  // Settings Handler werden in Story 1.5 implementiert
  // Metrics Handler werden in Story 3.x implementiert
}
```

### Fehlerbehandlung [Source: architecture/13-security.md]

```typescript
// src/shared/ipc/errors.ts

export type IpcErrorCode =
  | 'VALIDATION_ERROR'
  | 'NOT_FOUND'
  | 'DATABASE_ERROR'
  | 'UNKNOWN';

export interface IpcErrorResponse {
  code: IpcErrorCode;
  message: string;
}

export class IpcError extends Error {
  constructor(
    public readonly code: IpcErrorCode,
    message: string
  ) {
    super(message);
    this.name = 'IpcError';
  }

  toResponse(): IpcErrorResponse {
    return { code: this.code, message: this.message };
  }
}
```

### Coding Standards [Source: architecture/11-coding-standards.md]

| Element | Konvention | Beispiel |
|---------|------------|----------|
| IPC Channels | kebab:case | `articles:getAll` |
| TS Interfaces | PascalCase | `ElectronApi` |
| Files | camelCase | `channels.ts` |

**Kritische Regeln:**
- IPC Calls nur über `window.api` im Renderer, NIE direkt `ipcRenderer`
- Alle IPC Handler MÜSSEN Fehler abfangen
- Type Sharing: Typen in `src/shared/` definieren

### Hinweise für den Dev Agent

1. **Context Isolation:** MUSS aktiviert sein (`contextIsolation: true`). Ohne dies funktioniert `contextBridge` nicht und die App ist unsicher.

2. **Preload Path:** Der Pfad zum Preload-Script muss korrekt sein. Bei Electron Forge mit Vite ist dies typischerweise:
   ```typescript
   preload: path.join(__dirname, '../preload/index.js')
   ```

3. **TypeScript Config:** Die `window.d.ts` Datei muss in der TypeScript-Konfiguration eingebunden sein (normalerweise automatisch wenn in `src/`).

4. **Test-Channel:** Der "ping" → "pong" Test-Channel dient nur der Verifizierung. Er kann nach erfolgreichem Test entfernt oder für Debugging beibehalten werden.

5. **Handler Stubs:** Die eigentlichen CRUD-Handler für Articles, Categories, Settings werden in späteren Stories implementiert. Diese Story fokussiert auf die IPC-Infrastruktur.

6. **Vite Preload Config:** Electron Forge mit Vite hat eine separate `vite.preload.config.ts`. Sicherstellen dass Imports aus `../shared/` funktionieren.

### Testing

**Testing-Standards für diese Story:** [Source: architecture/14-testing-strategie.md]
- MVP-Phase: Keine automatisierten Tests erforderlich
- Manuelle Verifizierung der Acceptance Criteria ist ausreichend

**Manuelle Test-Checkliste:**
- [ ] `npm start` startet die App ohne Fehler
- [ ] Keine Security-Warnungen in der Electron Console
- [ ] DevTools öffnen (Ctrl+Shift+I)
- [ ] In Console eingeben: `await window.api.test.ping()`
- [ ] Ergebnis muss `"pong"` sein
- [ ] `window.api` zeigt alle API-Objekte (articles, categories, settings, metrics, test)
- [ ] TypeScript in IDE erkennt `window.api` ohne Typfehler

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-06 | 0.1 | Initial story draft | PO Sarah |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- **Kritisches Problem gelöst:** `window.api` war `undefined` weil Electron Forge Vite sowohl `src/main/index.ts` als auch `src/preload/index.ts` nach `.vite/build/index.js` gebaut hat (Dateinamen-Kollision). Lösung: Preload-Datei umbenannt zu `preload.ts` → Output wird `preload.js`.

### Completion Notes List

1. IPC Channel Konstanten in `src/shared/ipc/channels.ts` definiert
2. Type Definitionen für alle APIs in `src/shared/ipc/types.ts`
3. Window Type Declaration für `window.api` Typisierung
4. Preload Script mit contextBridge exponiert alle API-Methoden
5. BrowserWindow mit `contextIsolation: true`, `nodeIntegration: false`, `webSecurity: true`
6. IPC Handler Registration mit test:ping Handler
7. IpcError Klasse für strukturierte Fehlerbehandlung
8. **Wichtig:** Preload-Datei heißt `preload.ts` (nicht `index.ts`) wegen Vite Build-Konflikt
9. **Wichtig:** IPC_CHANNELS im Preload inline definiert (keine Imports aus shared wegen Vite)
10. `sandbox: true` entfernt wegen Kompatibilitätsproblemen

### File List

**Neue Dateien:**
- `src/shared/ipc/channels.ts` - IPC Channel Konstanten
- `src/shared/ipc/types.ts` - API Type Definitionen
- `src/shared/ipc/errors.ts` - IpcError Klasse
- `src/shared/ipc/window.d.ts` - Window.api Type Declaration
- `src/shared/ipc/index.ts` - Re-Exports
- `src/main/ipc/index.ts` - registerIpcHandlers()
- `src/main/ipc/handlers/` - Ordner für spätere Handler
- `src/preload/preload.ts` - Preload Script mit contextBridge

**Modifizierte Dateien:**
- `src/main/index.ts` - Security-Config + IPC-Registration
- `forge.config.ts` - Preload entry auf `src/preload/preload.ts` geändert

## QA Results

*To be filled by QA Agent*
