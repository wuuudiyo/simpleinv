# Story 2.3: Inventar-Tabelle mit Sortierung

## Status

Approved

## Story

**As a** Benutzer,
**I want** alle meine Artikel in einer übersichtlichen, sortierbaren Tabelle sehen,
**so that** ich schnell den Überblick behalte.

## Acceptance Criteria

1. Tabelle zeigt alle Artikel aus der Datenbank
2. Sichtbare Spalten: Titel, Kategorie, Status, Kaufpreis, Verkaufspreis, Profit
3. Profit wird berechnet angezeigt (nicht in DB gespeichert): Verkaufspreis − Kaufpreis − Gebühren − Versandkosten
4. Bei Artikeln ohne Verkaufspreis wird Profit als "–" oder leer angezeigt
5. Jede Spalte ist durch Klick auf den Header sortierbar (aufsteigend/absteigend)
6. Sortierrichtung wird durch Icon im Header angezeigt (▲/▼)
7. Status wird farblich hervorgehoben (In Stock: Blau, Listed: Orange, Sold: Grün, Returned: Rot)
8. Tabelle verwendet TanStack Table für Sortierlogik
9. Bei leerer Tabelle wird eine freundliche "Keine Artikel vorhanden" Nachricht angezeigt

## Tasks / Subtasks

- [ ] Task 1: TanStack Table installieren und konfigurieren (AC: 8)
  - [ ] `npm install @tanstack/react-table` ausführen
  - [ ] Basis-Typen für Table-Konfiguration verstehen

- [ ] Task 2: Berechnungs-Utility verifizieren/erstellen (AC: 3, 4)
  - [ ] `src/shared/utils/calculations.ts` verifizieren/erstellen
  - [ ] `calculateProfit(article): number | null` - Profit berechnen
  - [ ] `calculateRoi(article): number | null` - ROI berechnen (für spätere Stories)
  - [ ] `withCalculations(article): ArticleWithCalculations` - Artikel mit Berechnungen
  - [ ] Bei `salePrice === null` → Profit = null
  - [ ] Formel: `salePrice - purchasePrice - fees - shippingCostIn - shippingCostOut`

- [ ] Task 3: StatusBadge Komponente erstellen (AC: 7)
  - [ ] `src/renderer/components/ui/StatusBadge.tsx` erstellen
  - [ ] Props: `status: ArticleStatus`
  - [ ] Farbmapping implementieren:
    - `in_stock` → `bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200`
    - `listed` → `bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200`
    - `sold` → `bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200`
    - `returned` → `bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200`
  - [ ] Display-Labels: "In Stock", "Listed", "Sold", "Returned"

- [ ] Task 4: ArticleTable Komponente erstellen (AC: 1, 2, 5, 6, 8, 9)
  - [ ] `src/renderer/components/articles/ArticleTable.tsx` erstellen
  - [ ] Props Interface definieren:
    ```typescript
    interface ArticleTableProps {
      articles: ArticleWithCalculations[];
      onRowClick: (article: ArticleWithCalculations) => void;
      isLoading?: boolean;
    }
    ```
  - [ ] TanStack Table Setup mit `useReactTable`
  - [ ] Spalten-Definition für alle 6 Spalten
  - [ ] Sortierung aktivieren mit `getSortedRowModel()`
  - [ ] Sort-State verwalten: `sorting`, `onSortingChange`
  - [ ] Klickbare Header mit Sort-Icons
  - [ ] Empty State bei `articles.length === 0`

- [ ] Task 5: Spalten-Definitionen implementieren (AC: 2, 3, 4, 6, 7)
  - [ ] `columns` Array mit TanStack Column Helpers erstellen:
    - [ ] **Titel**: accessor `title`, sortierbar
    - [ ] **Kategorie**: accessor `categoryId`, Display als Name (oder "–" wenn null)
    - [ ] **Status**: accessor `status`, Custom Cell mit StatusBadge
    - [ ] **Kaufpreis**: accessor `purchasePrice`, Formatierung als €
    - [ ] **Verkaufspreis**: accessor `salePrice`, Formatierung als € (oder "–")
    - [ ] **Profit**: accessor `profit`, Formatierung als € mit Farbe (grün/rot/–)
  - [ ] Jede Spalte: Header mit Sort-Icon

- [ ] Task 6: Formatierungs-Utilities erstellen (AC: 3, 4)
  - [ ] `src/renderer/utils/formatters.ts` erstellen
  - [ ] `formatCurrency(value: number | null): string` - "€ 12,50" oder "–"
  - [ ] `formatProfit(profit: number | null): { text: string, className: string }`
    - null → { text: "–", className: "" }
    - >= 0 → { text: "€ X,XX", className: "text-green-600" }
    - < 0 → { text: "-€ X,XX", className: "text-red-600" }

- [ ] Task 7: Kategorie-Lookup für Tabelle (AC: 2)
  - [ ] Kategorie-Namen anzeigen statt ID
  - [ ] `useCategoryStore` in Tabelle oder Parent nutzen
  - [ ] Map erstellen: `categoryId → categoryName`
  - [ ] Fallback: "–" wenn categoryId null oder Kategorie nicht gefunden

- [ ] Task 8: Dashboard Integration (AC: 1)
  - [ ] `src/renderer/components/dashboard/DashboardPage.tsx` anpassen
  - [ ] `useArticleStore` und `useCategoryStore` nutzen
  - [ ] Artikel und Kategorien beim Mount laden
  - [ ] Artikel mit `withCalculations()` transformieren
  - [ ] ArticleTable einbinden und Props übergeben
  - [ ] `onRowClick` Handler für spätere Detail-Ansicht vorbereiten (console.log erstmal)

- [ ] Task 9: Styling und UX (AC: 5, 6, 7, 9)
  - [ ] Tabellen-Styling mit Tailwind:
    - Hover-States auf Zeilen (`hover:bg-gray-50 dark:hover:bg-gray-800`)
    - Cursor pointer für klickbare Zeilen
    - Alternating Row Colors optional
  - [ ] Sort-Icons in Headers: ▲ (asc), ▼ (desc), oder neutral
  - [ ] Empty State Box mit Icon und Text
  - [ ] Loading State optional (Skeleton oder Spinner)

- [ ] Task 10: Manuelle Verifizierung (Alle AC)
  - [ ] App starten ohne Fehler
  - [ ] Ohne Artikel: "Keine Artikel vorhanden" wird angezeigt
  - [ ] Artikel hinzufügen (via Story 2.2): Tabelle zeigt Artikel
  - [ ] Alle 6 Spalten sind sichtbar mit korrekten Werten
  - [ ] Profit-Berechnung: Artikel mit Verkaufspreis zeigt Profit
  - [ ] Profit-Berechnung: Artikel ohne Verkaufspreis zeigt "–"
  - [ ] Klick auf "Titel" Header: Sortiert A-Z, nochmal klicken: Z-A
  - [ ] Klick auf "Kaufpreis" Header: Sortiert aufsteigend/absteigend
  - [ ] Sort-Icon zeigt Richtung an (▲/▼)
  - [ ] Status-Badge zeigt korrekte Farben für jeden Status
  - [ ] Kategorie-Spalte zeigt Namen oder "–"
  - [ ] Zeilen haben Hover-Effekt
  - [ ] Dark Mode: Tabelle sieht korrekt aus

## Dev Notes

### Abhängigkeit von Story 2.1 und 2.2

Diese Story setzt voraus, dass **Story 2.1 (Kategorie-Verwaltung)** und **Story 2.2 (Artikel hinzufügen)** abgeschlossen sind, da:
- `categoryStore` und `articleStore` bereits implementiert sein müssen
- Artikel über das Formular hinzugefügt werden können, um die Tabelle zu testen
- Kategorie-Namen für die Anzeige benötigt werden

### ArticleWithCalculations Type [Source: architecture/4-datenmodelle.md]

```typescript
// src/shared/types/article.ts

export interface ArticleWithCalculations extends Article {
  profit: number | null;
  roi: number | null;
}
```

### Berechnungs-Utilities [Source: architecture/4-datenmodelle.md]

```typescript
// src/shared/utils/calculations.ts

import type { Article, ArticleWithCalculations } from '../types/article';

export function calculateProfit(article: Article): number | null {
  if (article.salePrice === null) return null;
  return (
    article.salePrice -
    article.purchasePrice -
    article.fees -
    article.shippingCostIn -
    article.shippingCostOut
  );
}

export function calculateRoi(article: Article): number | null {
  const profit = calculateProfit(article);
  if (profit === null || article.purchasePrice === 0) return null;
  return Math.round((profit / article.purchasePrice) * 10000) / 100;
}

export function withCalculations(article: Article): ArticleWithCalculations {
  return {
    ...article,
    profit: calculateProfit(article),
    roi: calculateRoi(article),
  };
}
```

### Status Display Mapping [Source: architecture/9-datenbank-schema.md]

| DB-Wert | Display | Tailwind Light | Tailwind Dark |
|---------|---------|----------------|---------------|
| `in_stock` | In Stock | `bg-blue-100 text-blue-800` | `dark:bg-blue-900 dark:text-blue-200` |
| `listed` | Listed | `bg-orange-100 text-orange-800` | `dark:bg-orange-900 dark:text-orange-200` |
| `sold` | Sold | `bg-green-100 text-green-800` | `dark:bg-green-900 dark:text-green-200` |
| `returned` | Returned | `bg-red-100 text-red-800` | `dark:bg-red-900 dark:text-red-200` |

```typescript
// src/shared/types/article.ts oder separates Mapping

export const STATUS_CONFIG: Record<ArticleStatus, { label: string; className: string }> = {
  in_stock: {
    label: 'In Stock',
    className: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
  },
  listed: {
    label: 'Listed',
    className: 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200',
  },
  sold: {
    label: 'Sold',
    className: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
  },
  returned: {
    label: 'Returned',
    className: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
  },
};
```

### StatusBadge Komponente [Source: architecture/6-komponenten-architektur.md]

```typescript
// src/renderer/components/ui/StatusBadge.tsx

import type { ArticleStatus } from '../../../shared/types/article';
import { STATUS_CONFIG } from '../../../shared/types/article';

interface StatusBadgeProps {
  status: ArticleStatus;
}

export function StatusBadge({ status }: StatusBadgeProps) {
  const config = STATUS_CONFIG[status];
  return (
    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${config.className}`}>
      {config.label}
    </span>
  );
}
```

### ArticleTable mit TanStack Table [Source: architecture/6-komponenten-architektur.md]

```typescript
// src/renderer/components/articles/ArticleTable.tsx

import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  flexRender,
  type SortingState,
  type ColumnDef,
} from '@tanstack/react-table';
import { useState, useMemo } from 'react';
import type { ArticleWithCalculations } from '../../../shared/types/article';
import { StatusBadge } from '../ui/StatusBadge';
import { formatCurrency, formatProfit } from '../../utils/formatters';

interface ArticleTableProps {
  articles: ArticleWithCalculations[];
  categories: Map<number, string>; // categoryId → name
  onRowClick: (article: ArticleWithCalculations) => void;
  isLoading?: boolean;
}

export function ArticleTable({ articles, categories, onRowClick, isLoading }: ArticleTableProps) {
  const [sorting, setSorting] = useState<SortingState>([]);

  const columns = useMemo<ColumnDef<ArticleWithCalculations>[]>(() => [
    {
      accessorKey: 'title',
      header: ({ column }) => (
        <SortableHeader column={column}>Titel</SortableHeader>
      ),
    },
    {
      accessorKey: 'categoryId',
      header: ({ column }) => (
        <SortableHeader column={column}>Kategorie</SortableHeader>
      ),
      cell: ({ row }) => {
        const categoryId = row.original.categoryId;
        return categoryId ? categories.get(categoryId) ?? '–' : '–';
      },
    },
    {
      accessorKey: 'status',
      header: ({ column }) => (
        <SortableHeader column={column}>Status</SortableHeader>
      ),
      cell: ({ row }) => <StatusBadge status={row.original.status} />,
    },
    {
      accessorKey: 'purchasePrice',
      header: ({ column }) => (
        <SortableHeader column={column}>Kaufpreis</SortableHeader>
      ),
      cell: ({ row }) => formatCurrency(row.original.purchasePrice),
    },
    {
      accessorKey: 'salePrice',
      header: ({ column }) => (
        <SortableHeader column={column}>Verkaufspreis</SortableHeader>
      ),
      cell: ({ row }) => formatCurrency(row.original.salePrice),
    },
    {
      accessorKey: 'profit',
      header: ({ column }) => (
        <SortableHeader column={column}>Profit</SortableHeader>
      ),
      cell: ({ row }) => {
        const { text, className } = formatProfit(row.original.profit);
        return <span className={className}>{text}</span>;
      },
    },
  ], [categories]);

  const table = useReactTable({
    data: articles,
    columns,
    state: { sorting },
    onSortingChange: setSorting,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
  });

  // Empty State
  if (articles.length === 0 && !isLoading) {
    return (
      <div className="text-center py-12 text-gray-500 dark:text-gray-400">
        <svg className="mx-auto h-12 w-12 text-gray-400" /* ... */ />
        <h3 className="mt-2 text-sm font-medium">Keine Artikel vorhanden</h3>
        <p className="mt-1 text-sm">
          Fügen Sie Ihren ersten Artikel hinzu, um loszulegen.
        </p>
      </div>
    );
  }

  return (
    <div className="overflow-x-auto">
      <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead className="bg-gray-50 dark:bg-gray-800">
          {table.getHeaderGroups().map((headerGroup) => (
            <tr key={headerGroup.id}>
              {headerGroup.headers.map((header) => (
                <th
                  key={header.id}
                  className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer select-none"
                  onClick={header.column.getToggleSortingHandler()}
                >
                  {flexRender(header.column.columnDef.header, header.getContext())}
                </th>
              ))}
            </tr>
          ))}
        </thead>
        <tbody className="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
          {table.getRowModel().rows.map((row) => (
            <tr
              key={row.id}
              onClick={() => onRowClick(row.original)}
              className="hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition-colors"
            >
              {row.getVisibleCells().map((cell) => (
                <td key={cell.id} className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                  {flexRender(cell.column.columnDef.cell, cell.getContext())}
                </td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}

// SortableHeader Helper Component
function SortableHeader({ column, children }: { column: any; children: React.ReactNode }) {
  const sortDirection = column.getIsSorted();
  return (
    <div className="flex items-center gap-1">
      {children}
      <span className="text-gray-400">
        {sortDirection === 'asc' && '▲'}
        {sortDirection === 'desc' && '▼'}
        {!sortDirection && '⇅'}
      </span>
    </div>
  );
}
```

### Formatierungs-Utilities

```typescript
// src/renderer/utils/formatters.ts

export function formatCurrency(value: number | null | undefined): string {
  if (value === null || value === undefined) return '–';
  return new Intl.NumberFormat('de-DE', {
    style: 'currency',
    currency: 'EUR',
  }).format(value);
}

export function formatProfit(profit: number | null): { text: string; className: string } {
  if (profit === null) {
    return { text: '–', className: 'text-gray-400' };
  }
  const formatted = formatCurrency(Math.abs(profit));
  if (profit >= 0) {
    return { text: formatted, className: 'text-green-600 dark:text-green-400' };
  }
  return { text: `-${formatted}`, className: 'text-red-600 dark:text-red-400' };
}

export function formatPercent(value: number | null): string {
  if (value === null) return '–';
  return `${value.toFixed(2)} %`;
}
```

### Dashboard Integration [Source: architecture/6-komponenten-architektur.md]

```typescript
// src/renderer/components/dashboard/DashboardPage.tsx

import { useEffect, useMemo } from 'react';
import { useArticleStore } from '../../stores/articleStore';
import { useCategoryStore } from '../../stores/categoryStore';
import { withCalculations } from '../../../shared/utils/calculations';
import { ArticleTable } from '../articles/ArticleTable';

export function DashboardPage() {
  const { articles, loadArticles, isLoading: articlesLoading } = useArticleStore();
  const { categories, loadCategories } = useCategoryStore();

  useEffect(() => {
    loadArticles();
    loadCategories();
  }, [loadArticles, loadCategories]);

  // Transform articles with calculations
  const articlesWithCalcs = useMemo(
    () => articles.map(withCalculations),
    [articles]
  );

  // Create category lookup map
  const categoryMap = useMemo(
    () => new Map(categories.map((c) => [c.id, c.name])),
    [categories]
  );

  const handleRowClick = (article: ArticleWithCalculations) => {
    console.log('Row clicked:', article);
    // TODO: Open detail modal in Story 2.4
  };

  return (
    <div className="p-6">
      {/* Metrics Cards (Platzhalter aus Story 1.4) */}
      <div className="grid grid-cols-3 gap-4 mb-6">
        {/* ... */}
      </div>

      {/* Action Bar */}
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-lg font-semibold">Inventar</h2>
        {/* Artikel hinzufügen Button aus Story 2.2 */}
      </div>

      {/* Article Table */}
      <div className="bg-white dark:bg-gray-900 rounded-lg shadow">
        <ArticleTable
          articles={articlesWithCalcs}
          categories={categoryMap}
          onRowClick={handleRowClick}
          isLoading={articlesLoading}
        />
      </div>
    </div>
  );
}
```

### File Locations [Source: architecture/10-projektstruktur.md]

```
src/
├── renderer/
│   ├── components/
│   │   ├── ui/
│   │   │   └── StatusBadge.tsx             ← NEU
│   │   ├── articles/
│   │   │   └── ArticleTable.tsx            ← NEU
│   │   └── dashboard/
│   │       └── DashboardPage.tsx           ← ANPASSEN
│   └── utils/
│       └── formatters.ts                    ← NEU
│
└── shared/
    ├── types/
    │   └── article.ts                       ← STATUS_CONFIG hinzufügen
    └── utils/
        └── calculations.ts                  ← Verifizieren/erweitern
```

### Coding Standards [Source: architecture/11-coding-standards.md]

| Element | Konvention | Beispiel |
|---------|------------|----------|
| React Components | PascalCase | `ArticleTable.tsx`, `StatusBadge.tsx` |
| Utility Functions | camelCase | `formatCurrency`, `calculateProfit` |
| Constants | UPPER_SNAKE_CASE | `STATUS_CONFIG` |

### TanStack Table Key Concepts

**Installation:**
```bash
npm install @tanstack/react-table
```

**Wichtige Hooks und Funktionen:**
- `useReactTable` - Haupt-Hook für Table-Instanz
- `getCoreRowModel()` - Basis Row Model
- `getSortedRowModel()` - Sortierung aktivieren
- `flexRender()` - Render-Helper für Cells und Headers
- `SortingState` - Type für Sorting-State
- `ColumnDef<T>` - Type für Spalten-Definition

**Sortierung:**
- `column.getToggleSortingHandler()` - Click Handler für Header
- `column.getIsSorted()` - Gibt 'asc', 'desc' oder false zurück
- `onSortingChange` - Callback für State-Update

### Testing

**Testing-Standards für diese Story:** [Source: architecture/14-testing-strategie.md]
- MVP-Phase: Keine automatisierten Tests erforderlich
- Manuelle Verifizierung der Acceptance Criteria ist ausreichend

**Manuelle Test-Checkliste:**
- [ ] `npm start` startet die App ohne Fehler
- [ ] Leere Tabelle zeigt "Keine Artikel vorhanden" Message
- [ ] Nach Hinzufügen eines Artikels: Zeile erscheint in Tabelle
- [ ] Alle 6 Spalten sichtbar: Titel, Kategorie, Status, Kaufpreis, Verkaufspreis, Profit
- [ ] Kaufpreis formatiert als "€ XX,XX"
- [ ] Verkaufspreis formatiert als "€ XX,XX" oder "–"
- [ ] Profit: Grün bei positivem Wert, Rot bei negativem, "–" wenn kein Verkaufspreis
- [ ] Kategorie zeigt Namen oder "–"
- [ ] Status-Badge hat korrekte Farbe je nach Status
- [ ] Klick auf Spalten-Header sortiert Tabelle
- [ ] Zweiter Klick auf gleichen Header kehrt Sortierung um
- [ ] Sort-Icon (▲/▼) zeigt aktuelle Richtung
- [ ] Zeilen haben Hover-Effekt
- [ ] Klick auf Zeile loggt Article-Objekt (Vorbereitung für Story 2.4)
- [ ] Dark Mode: Tabelle ist lesbar und styled

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-06 | 0.1 | Initial story draft | PO Sarah |

## Dev Agent Record

### Agent Model Used

*To be filled by Dev Agent*

### Debug Log References

*To be filled by Dev Agent*

### Completion Notes List

*To be filled by Dev Agent*

### File List

*To be filled by Dev Agent*

## QA Results

*To be filled by QA Agent*
