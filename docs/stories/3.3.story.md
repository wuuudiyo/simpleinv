# Story 3.3: Einstellungen-Seite

## Status

Approved

## Story

**As a** Benutzer,
**I want** eine dedizierte Einstellungen-Seite haben,
**so that** ich Theme und andere Optionen zentral verwalten kann.

## Acceptance Criteria

1. Einstellungen sind über ein Zahnrad-Icon in der App-Bar erreichbar
2. Einstellungen öffnen sich als Modal oder eigener Bereich
3. **Theme-Sektion:**
   - Radio-Buttons oder Segmented Control für Light/Dark/Custom
   - Bei Custom: Color Picker für Hintergrundfarbe wird eingeblendet
   - Vorschau der Farbänderung in Echtzeit
4. **Info-Sektion:**
   - App-Version anzeigen
   - Speicherort der Datenbank anzeigen (%APPDATA%/simpleinv/)
5. Änderungen werden automatisch gespeichert (keine "Speichern"-Button nötig)
6. "Schließen" Button kehrt zum Dashboard zurück

## Tasks / Subtasks

- [ ] Task 1: Settings Button in Header hinzufügen (AC: 1)
  - [ ] Zahnrad-Icon (Settings/Cog) in App-Bar rechts platzieren
  - [ ] Icon-Button mit Hover-State
  - [ ] Tooltip: "Einstellungen"
  - [ ] Click öffnet SettingsModal

- [ ] Task 2: SettingsModal Grundstruktur erstellen (AC: 2, 6)
  - [ ] `src/renderer/components/settings/SettingsModal.tsx` erstellen/überarbeiten
  - [ ] Modal-basierte Komponente mit `isOpen` und `onClose` Props
  - [ ] Titel: "Einstellungen"
  - [ ] Schließen-Button (X) und Klick außerhalb schließt Modal
  - [ ] Responsive Breite (z.B. max-w-md)

- [ ] Task 3: Theme-Sektion implementieren (AC: 3, 5)
  - [ ] `src/renderer/components/settings/ThemeSelector.tsx` erstellen
  - [ ] Radio-Buttons oder Segmented Control für Light/Dark/Custom
  - [ ] Aktueller Theme-Wert aus themeStore lesen
  - [ ] Bei Auswahl: themeStore.setTheme() aufrufen
  - [ ] Auto-Save bei jeder Änderung (keine Submit-Button)

- [ ] Task 4: Custom Theme Color Picker (AC: 3, 5)
  - [ ] Conditional Rendering: Color Picker nur bei Custom-Mode sichtbar
  - [ ] Color Picker Komponente (native HTML5 `<input type="color">` oder react-colorful)
  - [ ] Echtzeit-Vorschau: Farbänderung sofort anwenden
  - [ ] Debounce für häufige Farbänderungen (Performance)
  - [ ] Persistierung über themeStore.setCustomColor()

- [ ] Task 5: Info-Sektion implementieren (AC: 4)
  - [ ] `src/renderer/components/settings/InfoSection.tsx` erstellen
  - [ ] App-Version aus package.json oder Electron-API lesen
  - [ ] Datenbank-Pfad über IPC vom Main Process abrufen
  - [ ] Read-only Anzeige (nicht editierbar)
  - [ ] Copy-to-Clipboard für DB-Pfad (optional)

- [ ] Task 6: App-Info IPC Handler (AC: 4)
  - [ ] IPC Channel `app:getInfo` erstellen
  - [ ] Handler gibt zurück: { version: string, dbPath: string }
  - [ ] Version aus `app.getVersion()` (Electron)
  - [ ] DB-Pfad aus Database Service

- [ ] Task 7: Settings API im Preload erweitern (AC: 4)
  - [ ] `window.api.app.getInfo()` exponieren
  - [ ] Type-Definition für AppInfo Interface

- [ ] Task 8: DashboardPage Integration (AC: 1, 2)
  - [ ] State: `isSettingsOpen: boolean`
  - [ ] Settings-Icon Button ruft `setIsSettingsOpen(true)` auf
  - [ ] SettingsModal rendern mit onClose Handler

- [ ] Task 9: Manuelle Verifizierung (Alle AC)
  - [ ] App starten: Zahnrad-Icon in Header sichtbar
  - [ ] Klick öffnet Einstellungen-Modal
  - [ ] Theme-Sektion: Light/Dark/Custom Radio-Buttons sichtbar
  - [ ] Light auswählen → App wechselt zu hellem Theme
  - [ ] Dark auswählen → App wechselt zu dunklem Theme
  - [ ] Custom auswählen → Color Picker erscheint
  - [ ] Farbe ändern → Hintergrund ändert sich sofort
  - [ ] Modal schließen und neu öffnen → Theme-Auswahl bleibt
  - [ ] App neu starten → Theme ist persistiert
  - [ ] Info-Sektion: Version und DB-Pfad werden angezeigt
  - [ ] Schließen-Button schließt Modal

## Dev Notes

### Kontext aus vorherigen Stories

**Story 1.5** hat das Theme-System implementiert:
- themeStore mit `theme: 'light' | 'dark' | 'custom'`
- `customColor: string` für benutzerdefinierte Hintergrundfarbe
- Theme wird in Settings-Tabelle persistiert
- Theme-Wechsel funktioniert ohne App-Neustart

**Aktueller Stand:**
- Theme-Toggle existiert möglicherweise schon in der App-Bar (Story 1.5)
- Diese Story **konsolidiert** alle Einstellungen in einem Modal
- Theme-Toggle in App-Bar kann bleiben als Quick-Access

### Settings Types [Source: architecture/4-datenmodelle.md]

```typescript
// src/shared/types/settings.ts

export interface AppSettings {
  theme: 'light' | 'dark' | 'custom';
  customColor: string; // Hex-Farbe, z.B. "#4f46e5"
}

export interface AppInfo {
  version: string;
  dbPath: string;
}
```

### IPC Channels für App-Info

```typescript
// src/shared/ipc/channels.ts

export const IPC_CHANNELS = {
  // ... existing channels
  APP: {
    GET_INFO: 'app:getInfo',
  },
} as const;
```

### App Info Handler

```typescript
// src/main/ipc/handlers/appHandlers.ts

import { ipcMain, app } from 'electron';
import { IPC_CHANNELS } from '../../../shared/ipc/channels';
import { getDbPath } from '../../database';
import type { AppInfo } from '../../../shared/types/settings';

export function registerAppHandlers(): void {
  ipcMain.handle(IPC_CHANNELS.APP.GET_INFO, (): AppInfo => {
    return {
      version: app.getVersion(),
      dbPath: getDbPath(),
    };
  });
}
```

### SettingsModal Komponente [Source: architecture/6-komponenten-architektur.md]

```typescript
// src/renderer/components/settings/SettingsModal.tsx

interface SettingsModalProps {
  isOpen: boolean;
  onClose: () => void;
}

// Struktur:
// <Modal title="Einstellungen">
//   <ThemeSelector />
//   <Divider />
//   <InfoSection />
// </Modal>
```

### ThemeSelector Komponente

```typescript
// src/renderer/components/settings/ThemeSelector.tsx

import { useThemeStore } from '../../stores/themeStore';

export function ThemeSelector() {
  const { theme, setTheme, customColor, setCustomColor } = useThemeStore();

  return (
    <div className="space-y-4">
      <h3 className="font-medium">Design</h3>

      {/* Radio Buttons */}
      <div className="space-y-2">
        <label className="flex items-center gap-2">
          <input
            type="radio"
            name="theme"
            value="light"
            checked={theme === 'light'}
            onChange={() => setTheme('light')}
          />
          <span>Light Mode</span>
        </label>
        <label className="flex items-center gap-2">
          <input
            type="radio"
            name="theme"
            value="dark"
            checked={theme === 'dark'}
            onChange={() => setTheme('dark')}
          />
          <span>Dark Mode</span>
        </label>
        <label className="flex items-center gap-2">
          <input
            type="radio"
            name="theme"
            value="custom"
            checked={theme === 'custom'}
            onChange={() => setTheme('custom')}
          />
          <span>Eigene Farbe</span>
        </label>
      </div>

      {/* Color Picker (nur bei Custom) */}
      {theme === 'custom' && (
        <div className="flex items-center gap-3">
          <input
            type="color"
            value={customColor}
            onChange={(e) => setCustomColor(e.target.value)}
            className="w-10 h-10 rounded cursor-pointer"
          />
          <span className="text-sm text-gray-500">{customColor}</span>
        </div>
      )}
    </div>
  );
}
```

### InfoSection Komponente

```typescript
// src/renderer/components/settings/InfoSection.tsx

import { useEffect, useState } from 'react';
import type { AppInfo } from '../../../shared/types/settings';

export function InfoSection() {
  const [appInfo, setAppInfo] = useState<AppInfo | null>(null);

  useEffect(() => {
    window.api.app.getInfo().then(setAppInfo);
  }, []);

  if (!appInfo) {
    return <div>Lade...</div>;
  }

  return (
    <div className="space-y-3">
      <h3 className="font-medium">Info</h3>
      <div className="text-sm space-y-2">
        <div className="flex justify-between">
          <span className="text-gray-500">Version</span>
          <span>{appInfo.version}</span>
        </div>
        <div className="flex justify-between">
          <span className="text-gray-500">Datenbank</span>
          <span className="text-xs truncate max-w-[200px]" title={appInfo.dbPath}>
            {appInfo.dbPath}
          </span>
        </div>
      </div>
    </div>
  );
}
```

### Theme Store (Referenz von Story 1.5)

```typescript
// src/renderer/stores/themeStore.ts

import { create } from 'zustand';

type ThemeMode = 'light' | 'dark' | 'custom';

interface ThemeState {
  theme: ThemeMode;
  customColor: string;
  isLoading: boolean;
  loadTheme: () => Promise<void>;
  setTheme: (theme: ThemeMode) => Promise<void>;
  setCustomColor: (color: string) => Promise<void>;
}

export const useThemeStore = create<ThemeState>((set, get) => ({
  theme: 'light',
  customColor: '#4f46e5',
  isLoading: true,

  loadTheme: async () => {
    const savedTheme = await window.api.settings.get('theme');
    const savedColor = await window.api.settings.get('customColor');
    set({
      theme: (savedTheme as ThemeMode) || 'light',
      customColor: savedColor || '#4f46e5',
      isLoading: false,
    });
  },

  setTheme: async (theme: ThemeMode) => {
    set({ theme });
    await window.api.settings.set('theme', theme);
    applyTheme(theme, get().customColor);
  },

  setCustomColor: async (color: string) => {
    set({ customColor: color });
    await window.api.settings.set('customColor', color);
    if (get().theme === 'custom') {
      applyTheme('custom', color);
    }
  },
}));

function applyTheme(theme: ThemeMode, customColor: string) {
  const root = document.documentElement;
  root.classList.remove('light', 'dark');

  if (theme === 'light') {
    root.classList.add('light');
    root.style.removeProperty('--custom-bg');
  } else if (theme === 'dark') {
    root.classList.add('dark');
    root.style.removeProperty('--custom-bg');
  } else {
    root.style.setProperty('--custom-bg', customColor);
  }
}
```

### Preload Script Erweiterung

```typescript
// src/preload/index.ts

app: {
  getInfo: () => ipcRenderer.invoke(IPC_CHANNELS.APP.GET_INFO),
},
```

### File Locations [Source: architecture/10-projektstruktur.md]

```
src/
├── main/
│   └── ipc/
│       └── handlers/
│           └── appHandlers.ts         ← NEU
│
├── renderer/
│   └── components/
│       └── settings/
│           ├── SettingsModal.tsx       ← Überarbeiten
│           ├── ThemeSelector.tsx       ← NEU
│           └── InfoSection.tsx         ← NEU
│
└── shared/
    ├── types/
    │   └── settings.ts                 ← AppInfo hinzufügen
    └── ipc/
        └── channels.ts                 ← APP Channels hinzufügen
```

### UI Design [Source: architecture/6-komponenten-architektur.md]

**Modal Design:**
- Breite: max-w-md (448px)
- Padding: p-6
- Titel: "Einstellungen" mit Schließen-Button
- Sektionen mit Divider getrennt

**Theme-Sektion:**
- Radio-Buttons vertikal angeordnet
- Color Picker inline neben Hex-Wert

**Info-Sektion:**
- Key-Value Paare in zwei Spalten
- Kleine Schrift für Pfade

### Coding Standards [Source: architecture/11-coding-standards.md]

| Element | Konvention | Beispiel |
|---------|------------|----------|
| React Components | PascalCase | `SettingsModal.tsx` |
| IPC Channels | kebab:case | `app:getInfo` |

**Kritische Regeln:**
- Auto-Save: Jede Änderung sofort persistieren
- Keine Submit-Buttons für Einstellungen
- Theme-Änderungen sofort anwenden (reaktiv)

### Testing

**Testing-Standards für diese Story:** [Source: architecture/14-testing-strategie.md]
- MVP-Phase: Keine automatisierten Tests erforderlich
- Manuelle Verifizierung der Acceptance Criteria ist ausreichend

**Manuelle Test-Checkliste:**
- [ ] `npm start` startet die App ohne Fehler
- [ ] Zahnrad-Icon in Header/App-Bar sichtbar
- [ ] Klick öffnet Einstellungen-Modal
- [ ] Modal zeigt Theme-Sektion mit Radio-Buttons
- [ ] Light Mode auswählen → Theme wechselt sofort
- [ ] Dark Mode auswählen → Theme wechselt sofort
- [ ] Custom Mode auswählen → Color Picker erscheint
- [ ] Farbe im Color Picker ändern → Hintergrund ändert sich live
- [ ] Info-Sektion zeigt App-Version
- [ ] Info-Sektion zeigt Datenbank-Pfad
- [ ] Modal schließen (X oder außerhalb klicken)
- [ ] Modal erneut öffnen → Einstellungen sind erhalten
- [ ] App neu starten → Einstellungen sind persistiert
- [ ] Dark Mode: Modal sieht korrekt aus

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-06 | 0.1 | Initial story draft | PO Sarah |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Lint: 0 Errors, 3 Warnings (bestehend aus Epic 2)
- TypeCheck: OK
- App Start: OK

### Completion Notes List

1. App-Info IPC Handler erstellt (`app:getInfo`)
2. DatabaseService um `getDbPath()` erweitert
3. Preload API um `app.getInfo()` erweitert
4. AppInfo Interface in settings.ts definiert
5. ThemeSelector Komponente mit Radio-Buttons und Color Picker
6. InfoSection Komponente für Version und DB-Pfad
7. SettingsModal als Container für alle Settings-Sektionen
8. Header mit onSettingsClick Prop erweitert
9. AppLayout mit Settings Modal State integriert
10. **Bugfix:** Custom Theme CSS mit `!important` für Tailwind-Override (index.css + custom-theme-bg Klasse)

### File List

**Neue Dateien:**
- `src/main/ipc/handlers/appHandlers.ts`
- `src/renderer/components/settings/ThemeSelector.tsx`
- `src/renderer/components/settings/InfoSection.tsx`
- `src/renderer/components/settings/SettingsModal.tsx`

**Geänderte Dateien:**
- `src/shared/types/settings.ts` (AppInfo Interface)
- `src/shared/ipc/channels.ts` (APP.GET_INFO)
- `src/shared/ipc/types.ts` (AppApi Interface)
- `src/main/database/index.ts` (getDbPath Methode)
- `src/main/ipc/index.ts` (registerAppHandlers)
- `src/preload/preload.ts` (app.getInfo)
- `src/renderer/components/settings/index.ts` (Exports)
- `src/renderer/components/layout/Header.tsx` (onSettingsClick)
- `src/renderer/components/layout/AppLayout.tsx` (SettingsModal + custom-theme-bg)
- `src/renderer/index.css` (Custom Theme CSS Fix mit !important)

## QA Results

*To be filled by QA Agent*
